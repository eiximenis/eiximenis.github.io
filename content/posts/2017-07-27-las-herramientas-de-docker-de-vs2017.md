---
title: Las herramientas de Docker de VS2017

author: eiximenis

date: 2017-07-27T15:50:25+00:00
geeks_url: /?p=1907
geeks_ms_views:
  - 1818
categories:
  - docker
  - visual studio

---
Una de las novedades de VS2017 es el soporte integrado para Docker: podemos desplegar f√°cilmente nuestras soluciones en contenedores locales y depurar nuestro c√≥digo Docker que se ejecuta en un contenedor. **Pero‚Ä¶ ¬øc√≥mo funciona exactamente?**

**
  
** <!--more-->

**
  
** 
  
**Como habilitar el soporte para Docker**
  
Para a√±adir soporte Docker a un proyecto, basta con hacer click con el bot√≥n derecho en el _solution explorer_ y seleccionar la opci√≥n ‚ÄúAdd ‚Äì> Docker support‚Äù. Esto hace dos cosas:

  1. Crea el _Dockerfile_ necesario para crear una im√°gen de Docker de nuestro proyecto
  2. Crea los ficheros de _Compose_ necesarios para poner en marcha nuestro proyecto
  3. Crea el proyecto ‚Äúdocker-compose.dcproj‚Äù (que aparece en el _solution explorer)_:

[<img width="644" height="263" title="docker-compose.dcproj" style="display: inline; background-image: none;" alt="El proyecto docker-compose en el solution explorer" src="https://geeks.ms/etomas/wp-content/uploads/sites/154/2017/07/image_thumb.png" border="0" />][1]
  
Si seleccionamos el _docker-compose_ como proyecto de inicial, entonces veremos como el bot√≥n de ‚ÄúDebug Target‚Äù (el tri√°ngulo verde vamos :P) cambia a Docker. Y ahora pulsando F5, VS2017 va a lanzar nuestro proyecto usando _docker compose_.
  
Si tenemos varios proyectos en una soluci√≥n podemos agregar todos los que queramos a Docker y VS2017 crear√° un _Dockerfile_ para cada uno de ellos y los agregar√° al fichero de compose. Al usar F5 se lanzar√°n todos los proyectos de Docker, y podremos depurar cualquiera de ellos.
  
**El proyecto dcproj**
  
El proyecto dcproj es el encargado de incluir las tareas necesarias para ejecutar Docker dentro del pipeline de msbuild. A nivel de c√≥digo es muy simple:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: gray;">&lt;?</span><span style="color: rgb(86, 156, 214);">xml</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">version</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">1.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">encoding</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">utf-8</span><span style="color: gray;">"</span><span style="color: gray;">?&gt;</span><br /><span style="color: gray;">&lt;</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">ToolsVersion</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">15.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Sdk</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Microsoft.Docker.Sdk</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Label</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Globals</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">b0f0c876-c3ee-47fa-91f8-228b6948c08c</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">True</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">http://localhost:{ServicePort}/api/values</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">testdocker</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.ci.build.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.override.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.vs.debug.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.vs.release.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&gt;</span></pre>

**Si usas VS2017 Update 3 Preview 4** entonces el contenido es ligeramente distinto:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll;"><span style="color: gray;">&lt;?</span><span style="color: rgb(86, 156, 214);">xml</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">version</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">1.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">encoding</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">utf-8</span><span style="color: gray;">"</span><span style="color: gray;">?&gt;</span><br /><span style="color: gray;">&lt;</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">ToolsVersion</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">15.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Sdk</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Microsoft.Docker.Sdk</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Label</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Globals</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ProjectVersion</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">2.0</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">ProjectVersion</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerTargetOS</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">Linux</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerTargetOS</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">0b3c0c08-b9fe-4dee-b774-0494efab0535</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">True</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">http://localhost:{ServicePort}/api/values</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">testdockerpreview</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.ci.build.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.override.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&gt;</span></pre>

**Nota:** A partir de ahora nos referiremos a VS2017 Update 2 (actualmente en RTM) como VS15.2 y a VS2017 Update 3 (actualmente en Preview 4) como VS15.3.
  
La principal diferencia es la aparici√≥n de **DockerTargetOS** en VS15.3. Y esto es porque una de las novedades que incorpora VS15.3 es el soporte para contenedores windows nativos. Tambi√©n vemos como en el dcproj de VS15.2 hay unos ficheros _docker-compose.vs.debug.yml_ y _docker-compose.vs.release.yml_ que no aparecen en el dcproj de VS15.3. Dichos ficheros aparecen el _solution explorer_ de VS15.2. No es que hayan desaparecido en VS15.3, pero la idea es que dichos ficheros son generados por VS, as√≠ que no tiene sentido ni que aparezcan en el _solution explorer_ ni que est√©n en el control de c√≥digo fuente. As√≠ a partir de VS15.3, dichos ficheros los encontrar√°s en el directorio _obj/Docker_ de la soluci√≥n.
  
**¬øQu√© ocurre cuando compilamos y ejecutamos el dcproj?**
  
Cuando hacemos un _Build_ o ejecutamos el _dcproj_ desde VS, se van a crear los contenedores Docker, pero‚Ä¶ ¬øqu√© ocurre entre bambalinas?
  
Como te puedes imaginar, VS va a ejecutar las tareas definidas en el SDK ‚ÄúMicrosoft.Docker.Sdk‚Äù. Ese SDK es un SDK instalado por VS que **contiene los _targets_ de msbuild necesarios para terminar invocando a docker-compose para crear y levantar los contenedores** indicados en el fichero _docker-compose.yml._
  
Dicho as√≠, podr√≠amos pensar que ejecutar el proyecto con F5 desde VS o bien hacerlo desde la CLI usando docker-compose ser√≠a equivalente, pero realmente no es del todo as√≠.
  
La raz√≥n de esa diferencia (entre usar la CLI y VS) es, como te puedes imaginar, el fichero _docker-compose.vs.debug.yml_ (o su equivalente _release_). **¬øQu√© hace ese fichero?** Para responder esa a pregunta debemos empezar por analizar el _Dockerfile_ que nos genera VS:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll;"><span style="color: rgb(86, 156, 214);">FROM</span> microsoft/aspnetcore:1.1<br />ARG source<br />WORKDIR /app<br />EXPOSE 80<br />COPY ${source:-obj/Docker/publish} .<br />ENTRYPOINT [<span style="color: rgb(214, 157, 133);">"dotnet"</span>, <span style="color: rgb(214, 157, 133);">"TestDockerPreview.dll"</span>]<br /></pre>

Lo importante ah√≠ es la l√≠nea

<pre>COPY ${source:-obj/Docker/publish} .</pre>

**Esa l√≠nea es la que indica qu√© ficheros deben desplegarse en el contenedor**: Si existe la variable _source_ definida se copiar√° lo que haya en la variable _source_. En otro caso se copiar√° lo que haya en el directorio _obj/Docker/publish_.
  
Si queremos usar la CLI para crear contenedores cuyos _Dockerfile_ han sido creados por VS, la clave es que **el resultado de la publicaci√≥n est√© en obj/Docker/publish** (es decir que hayamos hecho ‚Äúdotnet publish ‚Äìo obj/Docker/publish‚Äù). Por lo tanto los binarios de mi aplicaci√≥n se copiaran en el contenedor (en el directorio /app del contenedor). Por lo tanto habitualmente usando la CLI har√≠amos dos cosas:

  1. dotnet publish ‚Äìo obj/Docker/publish
  2. docker-compose ‚Äìf docker-compose.yml ‚Äìf docker-compose.override.yml up

El primer comando publica el proyecto en /obj/Docker/publish y el segundo comando usa el fichero _docker-compose.yml_ que contiene la definici√≥n de las im√°genes y el fichero _docker-compose.override.yml_ (que contiene configuraci√≥n) para crear y ejecutar los contenedores.
  
B√°sicamente VS2017 hace lo mismo, pero a√±ade el fichero _docker-compose.vs.debug.yml_ a la sentencia docker-compose. Y este fichero es importante porque es parecido al siguiente (en 15.2):

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: rgb(218, 218, 218);">version:</span><span style="color: rgb(214, 157, 133);"> '2'<br /></span><br /><span style="color: rgb(218, 218, 218);">services:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp; <span style="color: rgb(218, 218, 218);">testdocker:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">image:</span><span style="color: rgb(214, 157, 133);"> testdocker:dev<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">build:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">args:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">source:</span><span style="color: rgb(214, 157, 133);"> $</span>{DOCKER_BUILD_SOURCE}<br />&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">environment:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> DOTNET_USE_POLLING_FILE_WATCHER=1<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">volumes:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> ./TestDocker:/app<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> ~/.nuget/packages:/root/.nuget/packages:ro<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> ~/clrdbg:/clrdbg:ro<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">entrypoint:</span><span style="color: rgb(214, 157, 133);"> tail -f /dev/null<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">labels:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> "com.microsoft.visualstudio.targetoperatingsystem=linux"</span></pre>

VS a√±ade el fichero _docker-compose.vs.debug.yml_ en √∫ltimo lugar cuando llama a docker-compose, por lo que eso significa que dicho fichero tiene preferencia (en caso de conflicto se van a tomar los valores de este fichero).
  
En un escenario multicontainer simplemente tendr√°s varias entradas en _services_, por supuesto. Lo interesante de este fichero es que hace lo siguiente:

  1. Asigna el nombre de la imagen _Docker_ para que tenga el tag ‚Äúdev‚Äù, con independencia del nombre y/o tag que tenga en el _docker-compose.yml_. **Eso hace que todas las im√°genes que lances con VS y las Docker tools (en debug) tendran el _tag_ ‚Äúdev‚Äù.** 
  2. Crea tres vol√∫menes (directorios compartidos entre host y container). Por un lado mapea al directorio /app del contenedor el directorio del proyecto. **Es decir, el container contendr√° en /app, no el resultado de la publicaci√≥n, si no los ficheros de c√≥digo fuente**. Es l√≥gico, ya que VS no publica el proyecto cuando lo ejecuta.
  3. El segundo vol√∫men mapea la cache de NuGet del host al contenedor, para que la resoluci√≥n de paquetes en el contenedor funcione.
  4. El tercer vol√∫men **mapea un directorio llamado clrdbg.** Este directorio contiene el depurador [clrdbg][2] que permite a VS depurar el contenedor. VS descarga clrdbg en el directorio %USERPROFILE%\clrdbg (si no existe) y lo mapea al contenedor para que as√≠ este lo tenga instalado.

VS15.3 sigue la misma filosof√≠a, pero recuerda que el fichero se _docker-compose.vs.debug.g.yml&nbsp;_ se encuentra en el directorio obj. El fichero es ligeramente distinto:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: rgb(218, 218, 218);">version:</span><span style="color: rgb(214, 157, 133);"> '3'<br /></span><br /><span style="color: rgb(218, 218, 218);">services:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp; <span style="color: rgb(218, 218, 218);">testdockerpreview:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">image:</span><span style="color: rgb(214, 157, 133);"> testdockerpreview:dev<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">build:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">args:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">source:</span><span style="color: rgb(214, 157, 133);"> obj/Docker/empty/<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">environment:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> DOTNET_USE_POLLING_FILE_WATCHER=1<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> NUGET_FALLBACK_PACKAGES=/root/.nuget/fallbackpackages<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">volumes:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">c:</span><span style="color: rgb(214, 157, 133);">\users\etoma\documents\visual studio 2017\Projects\TestDockerPreview\TestDockerPreview:/app<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">C:</span><span style="color: rgb(214, 157, 133);">\Users\etoma\vsdbg:/remote_debugger:ro<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">C:</span><span style="color: rgb(214, 157, 133);">\Users\etoma\.nuget\packages\:/root/.nuget/packages:ro<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">C:</span><span style="color: rgb(214, 157, 133);">\Users\etoma\.nuget\packages\:/root/.nuget/fallbackpackages:ro<br /></span><br />&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">entrypoint:</span><span style="color: rgb(214, 157, 133);"> tail -f /dev/null<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">labels:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.program</span>: <span style="color: rgb(214, 157, 133);">"dotnet"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.arguments</span>: <span style="color: rgb(214, 157, 133);">" --additionalProbingPath /root/.nuget/fallbackpackages&nbsp; bin/Debug/netcoreapp1.1/TestDockerPreview.dll"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.workingdirectory</span>: <span style="color: rgb(214, 157, 133);">"/app"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.killprogram</span>: <span style="color: rgb(214, 157, 133);">"/bin/bash -c \"if PID=$$(pidof -x dotnet); then kill $$PID; fi\""</span><br /></pre>

Al igual que VS15.2, VS15.3 tambi√©n fija el nombre y tag de la imagen Docker. La principal diferencia es&nbsp; que en lujgar de clrdbg se usa vsdbg que es la versi√≥n actualizada (y que al igual que 15.2, 15.3 se descarga autom√°ticamente). Por el resto el fichero es m√°s o menos parecido (la secci√≥n _labels_ es distinta porque 15.3 a√±ade m√°s metadatos a la imgen, pero eso es irrelevante para lo que a nosotros nos afecta).
  
En resumen, en _Debug_ los contenedores creados por VS:

  * Tendr√°n siempre el tag _dev_, con independencia del tag indicado en _docker-compose.yml_.
  * Tendr√°n un nombre fijo (el del proyecto). Dicho nombre es por defecto el mismo que el de _docker-compose.yml_, pero si lo cambias en _docker-compose.yml_ (p. ej. para crear im√°genes que sean de una organizaci√≥n) entonces este cambio no se reflejar√° cuando ejecutes los containers desde VS
  * Contendr√°n en /app el c√≥digo fuente (y los directorios /bin y /obj) en lugar del resultado de la publicaci√≥n
  * Contendr√°n en root/.nuget la cache local del host de nuget (a trav√©s de un vol√∫men)
  * Contendr√°n clrdbg (o vsdbg)&nbsp; (a trav√©s de un vol√∫men)

¬øY en release? Pues en release lo √∫nico que hace VS es a√±adir el vol√∫men para que el contenedor tenga clrdbg y/o vsdbg y as√≠ se pueda depurar. Nada m√°s. Eso s√≠, cuando construyas el proyecto en _Release_ se va a publicar en el directorio /obj/Docker/publish para que as√≠ pueda copiarse desde ese directorio al directorio /app del container. **Y no, ese directorio (obj/Docker/publish) no se puede modificar**. De hecho est√° metido ‚Äúa fuego‚Äù en el fichero _Microsoft.DotNet.Docker.Targets_ (que es referenciado por el _Docker.Sdk_):

<pre>&lt;dockerpublishdirectory>$(DockerIntermediateOutputPath)<strong>\publish</strong>&lt;/dockerpublishdirectory></pre>

**Limitaciones**
  
Actualmente VS2017 solo soporta tener un .dcproj cargado y adem√°s hay una cosa curiosa (que personalmente no me gusta) y es que **crear el dcproj poluciona el csproj asociado**. En efecto cuando a√±adimos un csproj al dcproj se a√±ade la siguiente l√≠nea en el csproj:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: gray;">&lt;</span><span style="color: rgb(86, 156, 214);">DockerComposeProjectPath</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">..\docker-compose.dcproj</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerComposeProjectPath</span><span style="color: gray;">&gt;</span><br /></pre>

Es bastante molesto, ya que el csproj deber√≠a ser independiente del dcproj pero bueno‚Ä¶ üôÅ
  
Bueno‚Ä¶ As√≠ es como funciona la interacci√≥n entre las docker tools, docker y VS2017. Espero que ahora te haya quedado un poco m√°s claro, como VS crea y gestiona nuestros contenedores _Docker_.

 [1]: https://geeks.ms/etomas/wp-content/uploads/sites/154/2017/07/image.png
 [2]: https://github.com/Microsoft/MIEngine/wiki/What-is-CLRDBG