---
title: Las herramientas de Docker de VS2017

author: eiximenis

date: 2017-07-27T15:50:25+00:00
geeks_url: /?p=1907
geeks_ms_views:
  - 1818
categories:
  - docker
  - visual studio

---
Una de las novedades de VS2017 es el soporte integrado para Docker: podemos desplegar fácilmente nuestras soluciones en contenedores locales y depurar nuestro código Docker que se ejecuta en un contenedor. **Pero… ¿cómo funciona exactamente?**

**
  
** <!--more-->

**
  
** 
  
**Como habilitar el soporte para Docker**
  
Para añadir soporte Docker a un proyecto, basta con hacer click con el botón derecho en el _solution explorer_ y seleccionar la opción “Add –> Docker support”. Esto hace dos cosas:

  1. Crea el _Dockerfile_ necesario para crear una imágen de Docker de nuestro proyecto
  2. Crea los ficheros de _Compose_ necesarios para poner en marcha nuestro proyecto
  3. Crea el proyecto “docker-compose.dcproj” (que aparece en el _solution explorer)_:

[<img width="644" height="263" title="docker-compose.dcproj" style="display: inline; background-image: none;" alt="El proyecto docker-compose en el solution explorer" src="https://geeks.ms/etomas/wp-content/uploads/sites/154/2017/07/image_thumb.png" border="0" />][1]
  
Si seleccionamos el _docker-compose_ como proyecto de inicial, entonces veremos como el botón de “Debug Target” (el triángulo verde vamos :P) cambia a Docker. Y ahora pulsando F5, VS2017 va a lanzar nuestro proyecto usando _docker compose_.
  
Si tenemos varios proyectos en una solución podemos agregar todos los que queramos a Docker y VS2017 creará un _Dockerfile_ para cada uno de ellos y los agregará al fichero de compose. Al usar F5 se lanzarán todos los proyectos de Docker, y podremos depurar cualquiera de ellos.
  
**El proyecto dcproj**
  
El proyecto dcproj es el encargado de incluir las tareas necesarias para ejecutar Docker dentro del pipeline de msbuild. A nivel de código es muy simple:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: gray;">&lt;?</span><span style="color: rgb(86, 156, 214);">xml</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">version</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">1.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">encoding</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">utf-8</span><span style="color: gray;">"</span><span style="color: gray;">?&gt;</span><br /><span style="color: gray;">&lt;</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">ToolsVersion</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">15.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Sdk</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Microsoft.Docker.Sdk</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Label</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Globals</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">b0f0c876-c3ee-47fa-91f8-228b6948c08c</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">True</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">http://localhost:{ServicePort}/api/values</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">testdocker</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.ci.build.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.override.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.vs.debug.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.vs.release.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&gt;</span></pre>

**Si usas VS2017 Update 3 Preview 4** entonces el contenido es ligeramente distinto:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll;"><span style="color: gray;">&lt;?</span><span style="color: rgb(86, 156, 214);">xml</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">version</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">1.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">encoding</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">utf-8</span><span style="color: gray;">"</span><span style="color: gray;">?&gt;</span><br /><span style="color: gray;">&lt;</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">ToolsVersion</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">15.0</span><span style="color: gray;">"</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Sdk</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Microsoft.Docker.Sdk</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Label</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">Globals</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ProjectVersion</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">2.0</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">ProjectVersion</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerTargetOS</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">Linux</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerTargetOS</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">0b3c0c08-b9fe-4dee-b774-0494efab0535</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">ProjectGuid</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">True</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerLaunchBrowser</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">http://localhost:{ServicePort}/api/values</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceUrl</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">testdockerpreview</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerServiceName</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">PropertyGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.ci.build.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.override.yml</span><span style="color: gray;">"</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DependentUpon</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: rgb(86, 156, 214);">None</span><span style="color: gray;">&nbsp;</span><span style="color: rgb(146, 202, 244);">Include</span><span style="color: gray;">=</span><span style="color: gray;">"</span><span style="color: rgb(200, 200, 200);">docker-compose.yml</span><span style="color: gray;">"</span><span style="color: gray;"> /&gt;</span><br /><span style="color: gray;">&nbsp; &lt;/</span><span style="color: rgb(86, 156, 214);">ItemGroup</span><span style="color: gray;">&gt;</span><br /><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">Project</span><span style="color: gray;">&gt;</span></pre>

**Nota:** A partir de ahora nos referiremos a VS2017 Update 2 (actualmente en RTM) como VS15.2 y a VS2017 Update 3 (actualmente en Preview 4) como VS15.3.
  
La principal diferencia es la aparición de **DockerTargetOS** en VS15.3. Y esto es porque una de las novedades que incorpora VS15.3 es el soporte para contenedores windows nativos. También vemos como en el dcproj de VS15.2 hay unos ficheros _docker-compose.vs.debug.yml_ y _docker-compose.vs.release.yml_ que no aparecen en el dcproj de VS15.3. Dichos ficheros aparecen el _solution explorer_ de VS15.2. No es que hayan desaparecido en VS15.3, pero la idea es que dichos ficheros son generados por VS, así que no tiene sentido ni que aparezcan en el _solution explorer_ ni que estén en el control de código fuente. Así a partir de VS15.3, dichos ficheros los encontrarás en el directorio _obj/Docker_ de la solución.
  
**¿Qué ocurre cuando compilamos y ejecutamos el dcproj?**
  
Cuando hacemos un _Build_ o ejecutamos el _dcproj_ desde VS, se van a crear los contenedores Docker, pero… ¿qué ocurre entre bambalinas?
  
Como te puedes imaginar, VS va a ejecutar las tareas definidas en el SDK “Microsoft.Docker.Sdk”. Ese SDK es un SDK instalado por VS que **contiene los _targets_ de msbuild necesarios para terminar invocando a docker-compose para crear y levantar los contenedores** indicados en el fichero _docker-compose.yml._
  
Dicho así, podríamos pensar que ejecutar el proyecto con F5 desde VS o bien hacerlo desde la CLI usando docker-compose sería equivalente, pero realmente no es del todo así.
  
La razón de esa diferencia (entre usar la CLI y VS) es, como te puedes imaginar, el fichero _docker-compose.vs.debug.yml_ (o su equivalente _release_). **¿Qué hace ese fichero?** Para responder esa a pregunta debemos empezar por analizar el _Dockerfile_ que nos genera VS:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll;"><span style="color: rgb(86, 156, 214);">FROM</span> microsoft/aspnetcore:1.1<br />ARG source<br />WORKDIR /app<br />EXPOSE 80<br />COPY ${source:-obj/Docker/publish} .<br />ENTRYPOINT [<span style="color: rgb(214, 157, 133);">"dotnet"</span>, <span style="color: rgb(214, 157, 133);">"TestDockerPreview.dll"</span>]<br /></pre>

Lo importante ahí es la línea

<pre>COPY ${source:-obj/Docker/publish} .</pre>

**Esa línea es la que indica qué ficheros deben desplegarse en el contenedor**: Si existe la variable _source_ definida se copiará lo que haya en la variable _source_. En otro caso se copiará lo que haya en el directorio _obj/Docker/publish_.
  
Si queremos usar la CLI para crear contenedores cuyos _Dockerfile_ han sido creados por VS, la clave es que **el resultado de la publicación esté en obj/Docker/publish** (es decir que hayamos hecho “dotnet publish –o obj/Docker/publish”). Por lo tanto los binarios de mi aplicación se copiaran en el contenedor (en el directorio /app del contenedor). Por lo tanto habitualmente usando la CLI haríamos dos cosas:

  1. dotnet publish –o obj/Docker/publish
  2. docker-compose –f docker-compose.yml –f docker-compose.override.yml up

El primer comando publica el proyecto en /obj/Docker/publish y el segundo comando usa el fichero _docker-compose.yml_ que contiene la definición de las imágenes y el fichero _docker-compose.override.yml_ (que contiene configuración) para crear y ejecutar los contenedores.
  
Básicamente VS2017 hace lo mismo, pero añade el fichero _docker-compose.vs.debug.yml_ a la sentencia docker-compose. Y este fichero es importante porque es parecido al siguiente (en 15.2):

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: rgb(218, 218, 218);">version:</span><span style="color: rgb(214, 157, 133);"> '2'<br /></span><br /><span style="color: rgb(218, 218, 218);">services:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp; <span style="color: rgb(218, 218, 218);">testdocker:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">image:</span><span style="color: rgb(214, 157, 133);"> testdocker:dev<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">build:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">args:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">source:</span><span style="color: rgb(214, 157, 133);"> $</span>{DOCKER_BUILD_SOURCE}<br />&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">environment:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> DOTNET_USE_POLLING_FILE_WATCHER=1<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">volumes:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> ./TestDocker:/app<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> ~/.nuget/packages:/root/.nuget/packages:ro<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> ~/clrdbg:/clrdbg:ro<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">entrypoint:</span><span style="color: rgb(214, 157, 133);"> tail -f /dev/null<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">labels:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> "com.microsoft.visualstudio.targetoperatingsystem=linux"</span></pre>

VS añade el fichero _docker-compose.vs.debug.yml_ en último lugar cuando llama a docker-compose, por lo que eso significa que dicho fichero tiene preferencia (en caso de conflicto se van a tomar los valores de este fichero).
  
En un escenario multicontainer simplemente tendrás varias entradas en _services_, por supuesto. Lo interesante de este fichero es que hace lo siguiente:

  1. Asigna el nombre de la imagen _Docker_ para que tenga el tag “dev”, con independencia del nombre y/o tag que tenga en el _docker-compose.yml_. **Eso hace que todas las imágenes que lances con VS y las Docker tools (en debug) tendran el _tag_ “dev”.** 
  2. Crea tres volúmenes (directorios compartidos entre host y container). Por un lado mapea al directorio /app del contenedor el directorio del proyecto. **Es decir, el container contendrá en /app, no el resultado de la publicación, si no los ficheros de código fuente**. Es lógico, ya que VS no publica el proyecto cuando lo ejecuta.
  3. El segundo volúmen mapea la cache de NuGet del host al contenedor, para que la resolución de paquetes en el contenedor funcione.
  4. El tercer volúmen **mapea un directorio llamado clrdbg.** Este directorio contiene el depurador [clrdbg][2] que permite a VS depurar el contenedor. VS descarga clrdbg en el directorio %USERPROFILE%\clrdbg (si no existe) y lo mapea al contenedor para que así este lo tenga instalado.

VS15.3 sigue la misma filosofía, pero recuerda que el fichero se _docker-compose.vs.debug.g.yml&nbsp;_ se encuentra en el directorio obj. El fichero es ligeramente distinto:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: rgb(218, 218, 218);">version:</span><span style="color: rgb(214, 157, 133);"> '3'<br /></span><br /><span style="color: rgb(218, 218, 218);">services:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp; <span style="color: rgb(218, 218, 218);">testdockerpreview:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">image:</span><span style="color: rgb(214, 157, 133);"> testdockerpreview:dev<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">build:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">args:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">source:</span><span style="color: rgb(214, 157, 133);"> obj/Docker/empty/<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">environment:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> DOTNET_USE_POLLING_FILE_WATCHER=1<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">-</span><span style="color: rgb(214, 157, 133);"> NUGET_FALLBACK_PACKAGES=/root/.nuget/fallbackpackages<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">volumes:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">c:</span><span style="color: rgb(214, 157, 133);">\users\etoma\documents\visual studio 2017\Projects\TestDockerPreview\TestDockerPreview:/app<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">C:</span><span style="color: rgb(214, 157, 133);">\Users\etoma\vsdbg:/remote_debugger:ro<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">C:</span><span style="color: rgb(214, 157, 133);">\Users\etoma\.nuget\packages\:/root/.nuget/packages:ro<br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(180, 180, 180);">- </span><span style="color: rgb(218, 218, 218);">C:</span><span style="color: rgb(214, 157, 133);">\Users\etoma\.nuget\packages\:/root/.nuget/fallbackpackages:ro<br /></span><br />&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">entrypoint:</span><span style="color: rgb(214, 157, 133);"> tail -f /dev/null<br /></span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">labels:</span><span style="color: rgb(214, 157, 133);"><br /></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.program</span>: <span style="color: rgb(214, 157, 133);">"dotnet"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.arguments</span>: <span style="color: rgb(214, 157, 133);">" --additionalProbingPath /root/.nuget/fallbackpackages&nbsp; bin/Debug/netcoreapp1.1/TestDockerPreview.dll"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.workingdirectory</span>: <span style="color: rgb(214, 157, 133);">"/app"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(218, 218, 218);">com.microsoft.visualstudio.debuggee.killprogram</span>: <span style="color: rgb(214, 157, 133);">"/bin/bash -c \"if PID=$$(pidof -x dotnet); then kill $$PID; fi\""</span><br /></pre>

Al igual que VS15.2, VS15.3 también fija el nombre y tag de la imagen Docker. La principal diferencia es&nbsp; que en lujgar de clrdbg se usa vsdbg que es la versión actualizada (y que al igual que 15.2, 15.3 se descarga automáticamente). Por el resto el fichero es más o menos parecido (la sección _labels_ es distinta porque 15.3 añade más metadatos a la imgen, pero eso es irrelevante para lo que a nosotros nos afecta).
  
En resumen, en _Debug_ los contenedores creados por VS:

  * Tendrán siempre el tag _dev_, con independencia del tag indicado en _docker-compose.yml_.
  * Tendrán un nombre fijo (el del proyecto). Dicho nombre es por defecto el mismo que el de _docker-compose.yml_, pero si lo cambias en _docker-compose.yml_ (p. ej. para crear imágenes que sean de una organización) entonces este cambio no se reflejará cuando ejecutes los containers desde VS
  * Contendrán en /app el código fuente (y los directorios /bin y /obj) en lugar del resultado de la publicación
  * Contendrán en root/.nuget la cache local del host de nuget (a través de un volúmen)
  * Contendrán clrdbg (o vsdbg)&nbsp; (a través de un volúmen)

¿Y en release? Pues en release lo único que hace VS es añadir el volúmen para que el contenedor tenga clrdbg y/o vsdbg y así se pueda depurar. Nada más. Eso sí, cuando construyas el proyecto en _Release_ se va a publicar en el directorio /obj/Docker/publish para que así pueda copiarse desde ese directorio al directorio /app del container. **Y no, ese directorio (obj/Docker/publish) no se puede modificar**. De hecho está metido “a fuego” en el fichero _Microsoft.DotNet.Docker.Targets_ (que es referenciado por el _Docker.Sdk_):

<pre>&lt;dockerpublishdirectory>$(DockerIntermediateOutputPath)<strong>\publish</strong>&lt;/dockerpublishdirectory></pre>

**Limitaciones**
  
Actualmente VS2017 solo soporta tener un .dcproj cargado y además hay una cosa curiosa (que personalmente no me gusta) y es que **crear el dcproj poluciona el csproj asociado**. En efecto cuando añadimos un csproj al dcproj se añade la siguiente línea en el csproj:

<pre style="background: rgb(30, 30, 30); color: gainsboro; font-family: consolas; white-space: nowrap; -ms-overflow-x: scroll; -ms-overflow-y: scroll;"><span style="color: gray;">&lt;</span><span style="color: rgb(86, 156, 214);">DockerComposeProjectPath</span><span style="color: gray;">&gt;</span><span style="color: rgb(200, 200, 200);">..\docker-compose.dcproj</span><span style="color: gray;">&lt;/</span><span style="color: rgb(86, 156, 214);">DockerComposeProjectPath</span><span style="color: gray;">&gt;</span><br /></pre>

Es bastante molesto, ya que el csproj debería ser independiente del dcproj pero bueno… 🙁
  
Bueno… Así es como funciona la interacción entre las docker tools, docker y VS2017. Espero que ahora te haya quedado un poco más claro, como VS crea y gestiona nuestros contenedores _Docker_.

 [1]: https://geeks.ms/etomas/wp-content/uploads/sites/154/2017/07/image.png
 [2]: https://github.com/Microsoft/MIEngine/wiki/What-is-CLRDBG