<!doctype html><html lang=es dir=ltr>
<head prefix="og: http://ogp.me/ns#">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>Como controlar un Application Gateway desde AKS – Lo Crestià</title>
<script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script>
<script defer src=/js/lazysizes.min.31dd6a2d3a1ec0f78a8df007535cf23f03aeb5c70f026e6d6a19dac3b3acc340.js></script>
<script defer src=/js/fuse.min.94c78ad70b02749822921660cf4e9f0b3701bc0680c421afb784a78228de0275.js></script>
<script defer src=/js/helper/getParents.min.ccd45f158c1b17849307ba913a72beac239c410f2b6e648496a79842da84e55b.js></script>
<script defer src=/js/helper/fadeinout.min.9fb19682560d5fa5596fffec85da605067c4acc86aad05add4d8fff9d362a446.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(b,a){'use strict';if(b instanceof RegExp)throw TypeError('first argument must not be a RegExp');return a===void 0&&(a=0),this.indexOf(b,a)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(a){if(!a.length)throw new Error('DOM Exception 8');if(a.length===1)return typeof a[0]=='string'?document.createTextNode(a[0]):a[0];for(var c=document.createDocumentFragment(),e=a.length,d=-1,b;++d<e;)b=a[d],c.appendChild(typeof b=='string'?document.createTextNode(b):b);return c}String.prototype.startsWith||(String.prototype.startsWith=function(b,a){return a=a||0,this.indexOf(b,a)===a}),document.addEventListener('DOMContentLoaded',function(){var y=document.querySelector('.navbar__burger'),e,c,H,s,V,O,N,q,g,A,k,n,r,t,F,P,d,C,f,D,E,X,z,B,$,h,i,b,w,S,aa,x,p,Q,l,ad,ac,a,ab,T,o,U,J,I,u,m,v;y?y.addEventListener('click',function(c){var a=document.querySelector('.navbarm__collapse'),b;a&&(b=a.getAttribute('data-open'),b==='true'?(a.setAttribute('data-open','false'),a.style.maxHeight=0,y.classList.remove('is-active')):(a.setAttribute('data-open','true'),a.style.maxHeight=a.scrollHeight+"px",y.classList.add('is-active')))}):null,e=document.querySelector('.summary__container'),c=document.querySelector('.search-result'),H=document.querySelector('.search-result__close'),H?H.addEventListener('click',function(a){c.setAttribute('data-display','none'),e.setAttribute('data-display','block')}):null,document.querySelectorAll('.tab')?document.querySelectorAll('.tab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.tab__link'),c=a.querySelectorAll('.tab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,document.querySelectorAll('.codetab')?document.querySelectorAll('.codetab').forEach(function(a,d){var e=a.getAttribute('id'),f=a,b=a.querySelectorAll('.codetab__link'),c=a.querySelectorAll('.codetab__content'),g=[];b&&b.length>0?b.forEach(function(b,d,a){b.onclick=function(e){for(var b=0;b<a.length;b++)d===parseInt(b,10)?a[b].classList.contains('active')||(a[b].classList.add('active'),c[b].style.display='block'):(a[b].classList.remove('active'),c[b].style.display='none')}}):null}):null,s=document.getElementById("gtt"),s.style.display="none",s.addEventListener('click',function(){window.document.documentMode?document.documentElement.scrollTop=0:W(250)});function W(a){var b=-window.scrollY/(a/15),c=setInterval(function(){window.scrollY!=0?window.scrollBy(0,b):clearInterval(c)},15)}V=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?s.style.display="block":s.style.display="none"},O=document.querySelectorAll('.expand__button');for(let a=0;a<O.length;a++)O[a].addEventListener("click",function(){var a=this.nextElementSibling;a.style.maxHeight?(a.style.maxHeight=null,this.querySelector('svg').classList.add('expand-icon__right'),this.querySelector('svg').classList.remove('expand-icon__down')):(a.style.maxHeight=a.scrollHeight+"px",this.querySelector('svg').classList.remove('expand-icon__right'),this.querySelector('svg').classList.add('expand-icon__down'))});N=window.pageYOffset||document.documentElement.scrollTop,q=document.querySelector('.toc'),g=q?q.querySelector('#TableOfContents'):null,A=document.getElementById('toggle-toc'),k=document.querySelector('.single__contents'),n=document.querySelector('.navbar'),r=document.querySelector('.toc__flexbox'),t=document.querySelector('.toc__flexbox--outer'),F=document.querySelectorAll('.expand__content'),P=document.querySelectorAll('.box'),d=null,C=JSON.parse("null"),f=JSON.parse("null"),f?f=f.toString():f="h1, h2, h3, h4, h5, h6",k&&k.querySelectorAll(".tab")?k.querySelectorAll(".tab").forEach(function(a){a.querySelectorAll(f).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,F?F.forEach(function(a){a.querySelectorAll(f).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,P?P.forEach(function(a){a.querySelectorAll(f).forEach(function(a){d=Array.isArray(d)?d.concat(a.getAttribute('id')):[a.getAttribute('id')]})}):null,window.onscroll=function(){V();var a=window.pageYOffset||document.documentElement.scrollTop;if(a>N){if(a<250?s.style.display="none":s.style.display="block",a<45)return null;n.classList.contains('navbar--hide')?n.classList.contains('navbar--show')&&n.classList.remove('navbar--show'):n.classList.add('navbar--hide'),k&&(k.querySelectorAll(f).length>0?k.querySelectorAll(f).forEach(function(c){var b,a;if(A&&!A.checked)return null;if(d&&d.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),q.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),q.querySelector('a[href="#'+b+'"]')?q.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===C||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(r&&(r.setAttribute('data-position',''),r.classList.contains('hide')||r.classList.add('hide')),t&&(t.setAttribute('data-position',''),t.classList.contains('hide')||t.classList.add('hide'))))}else a<250&&(s.style.display="none"),n.classList.contains('navbar--hide')?n.classList.remove('navbar--hide'):n.classList.contains('navbar--show')||n.classList.add('navbar--show'),k&&(k.querySelectorAll(f).length>0?k.querySelectorAll(f).forEach(function(c){var b,a;if(A&&!A.checked)return null;if(d&&d.includes(c.getAttribute('id')))return null;document.documentElement.scrollTop>=c.offsetTop&&g&&(b=c.getAttribute('id'),q.querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),q.querySelector('a[href="#'+b+'"]')?q.querySelector('a[href="#'+b+'"]').classList.add('active'):null,!1===C||(g.querySelectorAll('ul')?g.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),a=g.querySelector("[href='#"+b+"']"),a&&a.nextElementSibling&&(a.nextElementSibling.style.display='block'),getParents(a,'ul')?getParents(a,'ul').forEach(function(a){a.style.display='block'}):null)}):(r&&!r.classList.contains('hide')&&r.classList.add('hide'),t&&!t.classList.contains('hide')&&t.classList.add('hide'))),g&&document.documentElement.scrollTop<250&&(!1===C||(g.querySelector('ul')?g.querySelector('ul').querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})}):null));N=a<=0?0:a},D=localStorage.getItem('theme'),E=document.getElementById('root'),X=document.querySelectorAll('.select-theme'),z=document.querySelectorAll('.select-theme__item'),B=function(a){var b=document.getElementsByName('msapplication-TileColor')[0],c=document.getElementsByName('theme-color')[0],d=document.getElementsByName('msapplication-navbutton-color')[0],e=document.getElementsByName('apple-mobile-web-app-status-bar-style')[0];a.includes('dark')?(b.setAttribute('content','#fcfcfa'),c.setAttribute('content','#403E41'),d.setAttribute('content','#403E41'),e.setAttribute('content','#403E41')):a.includes('light')?(b.setAttribute('content','#555'),c.setAttribute('content','#eee'),d.setAttribute('content','#eee'),e.setAttribute('content','#eee')):a.includes('hacker')?(b.setAttribute('content','#e3cd26'),c.setAttribute('content','#252526'),d.setAttribute('content','#252526'),e.setAttribute('content','#252526')):a.includes('solarized')?(b.setAttribute('content','#d3af86'),c.setAttribute('content','#51412c'),d.setAttribute('content','#51412c'),e.setAttribute('content','#51412c')):a.includes('kimbie')&&(b.setAttribute('content','#586e75'),c.setAttribute('content','#eee8d5'),d.setAttribute('content','#eee8d5'),e.setAttribute('content','#eee8d5'))},D?(z?z.forEach(function(a){a.text.trim()===D?a.classList.add('is-active'):a.classList.remove('is-active')}):null,B(D)):B(E.className),z?z.forEach(function(a,b){a.addEventListener('click',function(c){var a=c.target.text.trim(),b;localStorage.setItem('theme',a),B(a),E.removeAttribute('class'),E.classList.add('theme__'+a),X.forEach(function(b){b.querySelectorAll('a').forEach(function(b){b.classList&&(b.text.trim()===a?b.classList.contains('is-active')||b.classList.add('is-active'):b.classList.contains('is-active')&&b.classList.remove('is-active'))})}),window.mermaid&&(a==="dark"||a==="hacker"?(mermaid.initialize({theme:'dark'}),location.reload()):(mermaid.initialize({theme:'default'}),location.reload())),b=document.querySelector('iframe'),b&&b.contentWindow.postMessage({type:'set-theme',theme:a==="dark"||a==="hacker"?'photon-dark':a==='kimbie'?'github-dark-orange':'github-light'},'https://utteranc.es')})}):null,$=JSON.parse('"https://www.eiximenis.dev/posts/2020-08-03-controlar-agic-desde-aks/"'),h=null,i=null,b=null,w=JSON.parse("true"),S=JSON.parse("null"),aa=JSON.parse('"posts"'),x=null,function(){var a=new XMLHttpRequest;a.open('GET',$+"index.json"),a.setRequestHeader('Content-Type','application/json; charset=utf-8'),a.onload=function(){a.status===200?(x=new Fuse(JSON.parse(a.response.toString('utf-8')),{keys:aa.includes('publication')?['title','abstract']:['title','description','content'],includeMatches:w,shouldSort:!0,threshold:.4,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1}),window.fuse=x):console.error('['+a.status+']Error:',a.statusText)},a.send()}();function _(e,a){var b=document.createElement('li'),c,d;b.className='search-result__item',c=document.createElement('a'),c.innerHTML=a.title,c.setAttribute('class','search-result__item--title'),c.setAttribute('href',a.permalink),d=document.createElement('div'),d.setAttribute('class','search-result__item--desc'),a.description?d.innerHTML=a.description:a.content&&(d.innerHTML=a.content.substring(0,225)),b.appendChild(c),b.appendChild(d),e.appendChild(b)}function Z(f,a){var e=document.createElement('li'),b,d,c;if(e.className='search-result__item',b=null,d=document.createElement('a'),d.innerHTML=a.item.title,d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri),a.matches&&a.matches.length){for(c=0;c<a.matches.length;c++)'title'===a.matches[c].key&&(d=document.createElement('a'),d.innerHTML=j(a.matches[c].value,a.matches[c].indices),d.setAttribute('class','search-result__item--title'),d.setAttribute('href',a.item.uri)),'description'===a.matches[c].key?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=j(a.item.description,a.matches[c].indices)):'content'===a.matches[c].key?b||(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=j(a.item.content.substring(0,150),a.matches[c].indices)):a.item.description?(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.description):(b=document.createElement('div'),b.setAttribute('class','search-result__item--desc'),b.innerHTML=a.item.content.substring(0,150));e.appendChild(d),b&&e.appendChild(b),e&&f.appendChild(e)}}function K(d,c){var a,b;for(h=document.getElementById('search-results'),i=document.getElementById('search-menu'),h.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var e=document.createElement('li'),c=document.createElement('a'),f,d;c.setAttribute('href',b.uri),c.setAttribute('class','dropdown-item'),c.appendChild(e),f=document.createElement('div'),f.innerHTML=b.title,f.setAttribute('class','menu-item__title'),d=document.createElement('div'),d.setAttribute('class','menu-item__desc'),b.description?d.innerHTML=b.description:b.content&&(d.innerHTML=b.content.substring(0,150)),e.appendChild(f),e.appendChild(d),a.appendChild(c)}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(a)}function L(d,c){var a,b;for(h=document.getElementById('search-results'),i=document.getElementById('search-menu'),h.setAttribute('class','dropdown is-active'),a=document.createElement('ul'),a.setAttribute('class','dropdown-content search-content'),c.length?c.forEach(function(b){var g=document.createElement('li'),e=document.createElement('a'),c=null,f,d;if(e.setAttribute('href',b.item.uri),e.setAttribute('class','dropdown-item'),e.appendChild(g),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','menu-item__title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=j(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=j(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=j(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','menu-item__desc'),c.innerHTML=b.item.content.substring(0,150));g.appendChild(f),c&&g.appendChild(c),a.appendChild(e)}}):(b=document.createElement('li'),b.setAttribute('class','dropdown-item'),b.innerText='No results found',a.appendChild(b));i.hasChildNodes();)i.removeChild(i.lastChild);i.appendChild(a)}function M(e,c){var a,d;h=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length>0?c.forEach(function(b){var c=document.createElement('a');c.setAttribute('href',b.uri),c.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+b.title+'</div><div class="mobile-search__item--desc">'+(b.description?b.description:b.content)+'</div></div>',a.appendChild(c)}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);h.appendChild(a)}function Y(e,c){var a,d;h=document.getElementById('search-mobile-results'),a=document.createElement('div'),a.setAttribute('class','mobile-search__content'),c.length?c.forEach(function(b){var e=document.createElement('li'),g=document.createElement('a'),c=null,f,d;if(g.setAttribute('href',b.item.uri),g.appendChild(e),e.setAttribute('class','mobile-search__item'),f=document.createElement('div'),f.innerHTML=b.item.title,f.setAttribute('class','mobile-search__item--title'),b.matches&&b.matches.length){for(d=0;d<b.matches.length;d++)'title'===b.matches[d].key&&(f.innerHTML=j(b.matches[d].value,b.matches[d].indices)),'description'===b.matches[d].key?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=j(b.item.description,b.matches[d].indices)):'content'===b.matches[d].key?c||(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=j(b.item.content.substring(0,150),b.matches[d].indices)):b.item.description?(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.description):(c=document.createElement('div'),c.setAttribute('class','mobile-search__item--desc'),c.innerHTML=b.item.content.substring(0,150));e.appendChild(f),c&&e.appendChild(c),a.appendChild(g)}}):(d=document.createElement('span'),a.appendChild(d));let b=document.getElementById('search-mobile-results');while(b.firstChild)b.removeChild(b.firstChild);h.appendChild(a)}function j(a,d){if(!d)return a;var b='',c=0;return d.forEach(function(d){if(d[0]===d[1])return null;b+=''+a.substring(c,d[0])+'<span class="search__highlight">'+a.substring(d[0],d[1]+1)+'</span>'+'',c=d[1]+1}),b+=a.substring(c),b}p=document.getElementById('search'),Q=document.getElementById('search-mobile'),l=document.getElementById('search-results'),p?p.addEventListener('input',function(d){var a,f;if(!d.target.value|window.innerWidth<770)return l?l.setAttribute('class','dropdown'):null,c?c.setAttribute('data-display','none'):null,e?e.setAttribute('data-display','block'):null,null;b=d.target.value,a=x.search(d.target.value),S==="main"?w?R(b,a):G(b,a):(w?L(b,a):K(b,a),f=l.querySelectorAll('.dropdown-item'),f?f.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,p?p.addEventListener('blur',function(){if(window.innerWidth<770)return null;l?l.setAttribute('class','dropdown'):null}):null,p?p.addEventListener('click',function(c){var a,d;if(window.innerWidth<770)return null;if(!c.target.value)return l?l.setAttribute('class','dropdown'):null,null;b=c.target.value,a=x.search(c.target.value),S==="main"?w?R(b,a):G(b,a):(w?L(b,a):K(b,a),d=l.querySelectorAll('.dropdown-item'),d?d.forEach(function(a){a.addEventListener('mousedown',function(a){a.target.click()})}):null)}):null,ad=document.getElementById("search-menu"),ac=document.querySelector('#search-menu .dropdown-item.is-active'),a=null,ab=null,T=350,p?p.addEventListener('keydown',function(d){var b,f;if(window.innerWidth<770)return null;if(d.key==='Escape'&&(c?c.setAttribute('data-display','none'):null,e?e.setAttribute('data-display','block'):null),b=document.querySelectorAll('#search-menu .dropdown-item'),f=d.which||d.keyCode,!b||!b.length)return null;if(d.key==='ArrowDown'||f===40){a===null?(a=0,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===b.length-1?0:a+1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-T;c>0?document.querySelector(".search-content").scrollTop+=b[a].getBoundingClientRect().height:a===0&&(document.querySelector(".search-content").scrollTop=0)}else if(d.key==='ArrowUp'||f===38){a===null?(a=b.length-1,b[a].classList.remove('is-active')):(b[a].classList.remove('is-active'),a=a===0?b.length-1:a-1),b[a].classList.add('is-active');let c=b[a].offsetTop+b[a].clientHeight-T;c<0?document.querySelector(".search-content").scrollTop-=b[a].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=c+b[a].getBoundingClientRect().height}else d.key==='Enter'||f===13?b[a]&&b[a].getAttribute('href')&&(location.href=b[a].getAttribute('href')):(d.key==='Escape'||f===27)&&(d.target.value=null,h&&h.classList.remove('is-active'))}):null,Q?Q.addEventListener('input',function(a){if(!a.target.value){let a=document.getElementById('search-mobile-results');while(a.firstChild)a.removeChild(a.firstChild);return null}b=a.target.value;var c=x.search(a.target.value);M(b,c),w?Y(b,c):M(b,c)}):null,o=document.querySelector('#search-mobile'),U=document.querySelector('.mobile-search'),J=document.querySelector('#mobileSearchBtn'),I=document.querySelector('#search-mobile-close'),u=document.querySelector('#search-mobile-container'),m=document.querySelector('#search-mobile-results'),v=document.querySelector('html'),U&&(U.style.display='none'),J?J.addEventListener('click',function(){u&&(u.style.display='block'),o&&o.focus(),v&&(v.style.overflowY='hidden')}):null,I?I.addEventListener('click',function(){if(u&&(u.style.display='none'),o&&(o.value=''),m)while(m.firstChild)m.removeChild(m.firstChild);v&&(v.style.overflowY='visible')}):null,o?o.addEventListener('keydown',function(a){var b=a.which||a.keyCode;if(a.key==='Escape'||b===27){if(u&&(u.style.display='none'),o&&(o.value=''),m)while(m.firstChild)m.removeChild(m.firstChild);v&&(v.style.overflowY='visible')}}):null;function G(f,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),d=document.createElement('ul');f?a&&a&&a.length&&(a.forEach(function(a){_(d,a)}),c?c.setAttribute('data-display','block'):null,e?e.setAttribute('data-display','none'):null):(c?c.setAttribute('data-display','none'):null,e?e.setAttribute('data-display','block'):null),b.parentNode.replaceChild(d,b)}function R(f,a){var g=document.querySelector('.search-result__body'),b=g.querySelector('ul'),d=document.createElement('ul');f?a&&a&&a.length&&(a.forEach(function(a){Z(d,a)}),c?c.setAttribute('data-display','block'):null,e?e.setAttribute('data-display','none'):null):(c?c.setAttribute('data-display','none'):null,e?e.setAttribute('data-display','block'):null),b.parentNode.replaceChild(d,b)}})</script>
<link rel=stylesheet href=/css/main.min.css>
<link rel=stylesheet href=/terminal.min.css>
<meta name=description content="Si quieres saber como configurar y controlar un Application Gateway a través del controlador ingress de AKS, en este post, Jorge responderá a todas tus dudas! :)">
<meta name=created content="2020-08-03T18:00:00+0000">
<meta name=modified content="2020-08-03T18:00:00+0000">
<meta property="article:published_time" content="2020-08-03T18:00:00+0000">
<meta name=author content="Jorge Turrado">
<meta property="article:author" content="https://www.eiximenis.dev/posts/2020-08-03-controlar-agic-desde-aks/@Jorge Turrado">
<meta property="og:site_name" content="Lo Crestià">
<meta property="og:title" content="Como controlar un Application Gateway desde AKS">
<meta property="og:url" content="https://www.eiximenis.dev/posts/2020-08-03-controlar-agic-desde-aks/">
<meta property="og:type" content="article">
<meta property="og:description" content="Si quieres saber como configurar y controlar un Application Gateway a través del controlador ingress de AKS, en este post, Jorge responderá a todas tus dudas! :)">
<meta name=generator content="Hugo 0.89.3">
<meta name=msapplication-TileColor content="#fff">
<meta name=theme-color content="#fff">
<meta name=msapplication-navbutton-color content="#fff">
<meta name=apple-mobile-web-app-status-bar-style content="#fff">
<link rel=canonical href=https://www.eiximenis.dev/posts/2020-08-03-controlar-agic-desde-aks/>
<link rel=manifest href=/manifest.json>
<link rel="shortcut icon" href=/favicon.ico type=image/x-icon>
<link rel=icon href=/favicon.png sizes=any type=image/png>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"WebPage","headline":"Como controlar un Application Gateway desde AKS","datePublished":"2020-08-03T18:00:00Z","dateModified":"2020-08-03T18:00:00Z","url":"https://www.eiximenis.dev/posts/2020-08-03-controlar-agic-desde-aks/","description":"Si quieres saber como configurar y controlar un Application Gateway a través del controlador ingress de AKS, en este post, Jorge responderá a todas tus dudas! :)","author":{"@type":"Person","name":"Jorge Turrado"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.eiximenis.dev/"},"publisher":{"@type":"Organization","name":"Lo Crestià","url":"https://www.eiximenis.dev/"}}</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EHG7PQ0GZK"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-EHG7PQ0GZK')</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-332827-15','auto'),ga('send','pageview'))</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-332827-15','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body id=root class=theme__dark>
<script>var localTheme=localStorage.getItem('theme');localTheme&&(document.getElementById('root').className='theme__'+localTheme)</script>
<div id=container>
<div class=wrapper data-type=posts data-kind=page>
<nav class=navbar role=navigation aria-label="main navigation" data-dir=ltr>
<div class=navbar__brand>
<a href=/ title=Incio rel=home class=navbar__logo-link>
<img src=/logo.png alt=Home class=navbar__logo>
</a>
<a href=/ title=Incio rel=home class=navbar__title-link>
<h6 class=navbar__title>Lo Crestià</h6>
</a>
</div>
<div class="theme theme-mobile" data-ani=true>
<div class=dropdown>
<button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>
</button>
<div class="dropdown-content select-theme">
<a href=# class="dropdown-item select-theme__item is-active">
dark
</a>
<a href=# class="dropdown-item select-theme__item">
light
</a>
<a href=# class="dropdown-item select-theme__item">
hacker
</a>
<a href=# class="dropdown-item select-theme__item">
solarized
</a>
</div>
</div>
</div>
<div id=mobileSearchBtn class=mobile-search__btn data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</div>
<div id=search-mobile-container class="mobile-search hide" data-dir=ltr>
<div class=mobile-search__top>
<input id=search-mobile type=text aria-label="Mobile Search" placeholder=Buscar class=mobile-search__top--input>
<div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg>
</div>
</div>
<div id=search-mobile-results class=mobile-search__body>
</div>
</div>
<a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<div class=navbarm__collapse data-open=false>
<ul dir=ltr>
<li class="navbarm__menu--item active">
<a href=/posts>posts</a>
</li>
<li class=navbarm__menu--item>
<a href=/talks>charlas</a>
</li>
<li class=navbarm__menu--item>
<a href=/gallery>
fotos<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg>
</a>
</li>
<li class="navbarm__menu--item navbarm__menu--subitem">
<a href=/gallery/events>charlas</a>
</li>
<li class=navbarm__menu--item>
<a href=/oss>oss</a>
</li>
<li class=navbarm__menu--item>
<a href=/about>
sobre<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg>
</a>
</li>
<li class="navbarm__menu--item navbarm__menu--subitem">
<a href=/about/cursos>Mis Cursos</a>
</li>
<li class="navbarm__menu--item navbarm__menu--subitem">
<a href=/about/yo>Mí</a>
</li>
</ul>
</div>
<div class=navbar__menu>
<div class=theme data-ani=true>
<div class=dropdown>
<button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg>
</button>
<div class="dropdown-content select-theme">
<a href=# class="dropdown-item select-theme__item is-active">
dark
</a>
<a href=# class="dropdown-item select-theme__item">
light
</a>
<a href=# class="dropdown-item select-theme__item">
hacker
</a>
<a href=# class="dropdown-item select-theme__item">
solarized
</a>
</div>
</div>
</div>
<a href=/posts class="navbar__menu-item navbar__slide-down active" dir=ltr data-ani=true>posts</a>
<a href=/talks class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>charlas</a>
<div class="navbar__dropdown navbar__slide-down" data-ani=true>
<a href=/gallery class=navbar__menu-item dir=ltr>
fotos<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg>
</a>
<div class=navbar__dropdown--content>
<a href=/gallery/events class=navbar__dropdown--item dir=ltr>charlas</a>
</div>
</div>
<a href=/oss class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>oss</a>
<div class="navbar__dropdown navbar__slide-down" data-ani=true>
<a href=/about class=navbar__menu-item dir=ltr>
sobre<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg>
</a>
<div class=navbar__dropdown--content>
<a href=/about/cursos class=navbar__dropdown--item dir=ltr>Mis Cursos</a>
<a href=/about/yo class=navbar__dropdown--item dir=ltr>Mí</a>
</div>
</div>
</div>
</nav>
<main class="single__main main-main">
<nav class="breadcrumb hide" aria-label=breadcrumbs>
<script>document.querySelector('.breadcrumb').classList.remove('hide')</script>
<ol>
<li>
<a href=https://www.eiximenis.dev/ class=capitalize>Lo Crestià</a>
</li>
<li>
<a href=https://www.eiximenis.dev/posts/ class=capitalize>Posts</a>
</li>
<li class=is-active>
<span>Como controlar un Application Gateway desde AKS</span>
</li>
</ol>
</nav>
<div class=single>
<div class=single__nojs>This page looks best with JavaScript enabled</div>
<script>document.querySelector('.single').classList.remove('hide'),document.querySelector('.single__nojs').classList.add('hide')</script>
<h2 class=single__title data-ani=true>Como controlar un Application Gateway desde AKS</h2>
<div class=single__meta>
<div class=single__infos>
<time class=single__info title="Escrito en">📅&nbsp;Aug 3, 2020 </time>
&nbsp;&#183;&nbsp; <span class=single__info title="Tiempo lectura"> ☕&nbsp;11&nbsp;min </span>
&nbsp;&#183;&nbsp; <span class=single__info title="ESCRITO POR">🐛&nbsp;Jorge Turrado</span>
<span class=single__info>
</span>
</div>
<ul class="single__tags caption">
</ul>
</div>
<article class=single__contents data-dir=ltr data-ani=true>
<h1 id=como-controlar-un-application-gateway-desde-aks>Como controlar un Application Gateway desde AKS</h1>
<blockquote>
<p>Esta entrada está escrita por <a href=https://twitter.com/JorgeTurrado>Jorge Turrado</a>, un crack tanto en lo personal como en lo profesional. Es un placer que haya elegido mi blog para publicar esa entrada. Si quieres leer más cosas publicadas por Jorge, pásate por su blog: <a href=https://www.fixedbuffer.com/>Fixed Buffer</a>. ¡Gracias!</p>
</blockquote>
<p>Es un gusto poder estar aquí en el blog del grandísimo Eduard Tomas, el cual me ha abierto sus puertas encantado para escribir sobre un tema que personalmente me ha resultado muy interesante y útil. Os pongo en situación.</p>
<p>En los últimos meses he participado en un proyecto con una arquitectura típica trabajando con Kubernetes, teníamos nuestro nginx ingress controller desde el que enrutabamos el tráfico hacia los diferentes servicios y de ahí hacia sus respectivos pods. Todo esto trabajando sobre la nube de Microsoft, es decir, en AKS. En un momento dado, se tomo la decisión de poner por delante del AKS un <a href=https://docs.microsoft.com/es-es/azure/application-gateway/overview>Application Gateway</a> (de aquí en adelante <strong>agw</strong>) que enrutase el tráfico de internet hacia el cluster. El escenario final con el que íbamos a trabajar era algo similar a esto:</p>
<p><img src=/images/posts/2020-08-03-agw-nginx.png alt="&ldquo;La imagen muestra un diagrama donde se indica que las peticiones HTTP llegan al Application Gateway y se enrutan hacia el AKS llegando al Nginx ingress controller, y de ahí al servicio y a sus pods&rdquo;"></p>
<blockquote>
<p>Por si no conocéis Application Gateway, es un servicio de Azure que hace de &ldquo;proxy inverso&rdquo; y permite ciertas configuraciones de seguridad. Esto es muy útil a la hora de exponer ciertas partes de una red virtual privada hacia internet teniendo un control sobre lo que esta expuesto. En este caso un AKS, pero también podrían ser diferentes máquinas virtuales,etc&mldr;</p>
</blockquote>
<p>Por hacer un breve resumen, las peticiones llegan al agw y desde ahí se reenvían al cluster, nginx recibe la petición y la enruta hacia el servicio correspondiente, y este último hacia el pod que le toca. Hemos añadido una capa más de seguridad a nuestro cluster al colocarlo detrás de un agw, pero hemos añadido un salto de red más que si nuestro escenario expusiera directamente el nginx. Aunque esto puede ser totalmente irrelevante en la gran mayoría de los casos, el salto extra esta ahí y tiene su coste.</p>
<p>Esto tiene una mejor solución (sino no estaría escribiendo esto), y consiste en utilizar el propio <em>ingress controller</em> que ofrece Microsoft para trabajar directamente contra el agw. Este <em>ingress controller</em> se llama &ldquo;<strong>A</strong>pplication <strong>G</strong>ateway <strong>I</strong>ngress <strong>C</strong>ontroller&rdquo; (de ahora en adelante <strong>agic</strong>). La manera de funcionar de este controlador consiste en analizar los objetos ingress que le pertenecen y realizar despliegues directamente sobre el agw. Con esto lo que vamos a conseguir es que el tráfico se enrute desde el agw directamente hacia los pods, evitándonos así 2 saltos de red. El nuevo planteamiento es algo similar a esto:</p>
<p><img src=/images/posts/2020-08-03-agw-agic.png alt="&ldquo;La imagen muestra un diagrama donde se indica que las peticiones HTTP llegan al Application Gateway y se enrutan directamente a los pods&rdquo;"></p>
<blockquote>
<p>El <a href=https://github.com/Azure/application-gateway-kubernetes-ingress>código fuente de agic</a> esta disponible en GithHub para poder echarle una ojeada.</p>
</blockquote>
<h2 id=prerrequisitos>Prerrequisitos</h2>
<p>Contar esto es muy fácil, pero yo soy más de los que piensa que es mejor ver que oir, vamos a poner en marcha agic desde 0. Para eso, vamos a necesitar de varias cosas. Por supuesto un AKS y un Application Gateway (¿a qué nadie se lo imaginaba?), pero además también vamos a necesitar que ambos estén conectados a una red privada virtual (de aquí en adelante vnet) y dar permisos a agic para ver y editar el agw.</p>
<blockquote>
<p>No es necesario que AKS y agw esten en la misma vnet, pueden estar desplegados en diferentes vnets sin ningún problema, pero en ese caso será necesario hacer los <a href=https://docs.microsoft.com/es-es/azure/virtual-network/virtual-network-peering-overview>peerings</a> correspondientes entre las redes para que las peticiones puedan viajar desde agw hasta el cluster.</p>
</blockquote>
<p>Para los más veteranos en manejo de AKS, conoceréis que existen 2 tipos modos de manejar las identidades en un cluster de Kubernetes de Azure, utilizando un <em>service principal</em> o una identidad manejada. Esto mismo es aplicable también a como dar permisos sobre agic, que soporta los dos escenarios. Personalmente soy de los que opinan que es mejor gestionar permisos desde una identidad manejada que desde un <em>service principal</em>, y como me gusta complicarme vida, es el modelo que vamos a utilizar aquí. Por tanto, la lista de cosas que vamos a necesitar en cuanto a infraestructura es:</p>
<ul>
<li>Grupo de recursos</li>
<li>Red Privada Virtual</li>
<li>AKS</li>
<li>Application Gateway</li>
<li>Asignación de permisos para las identidad manejada de AKS</li>
</ul>
<p>Una vez que tenemos claro lo que necesitamos desplegar antes de meternos en harina dentro del cluster, vamos con ello. Lo primero que vamos a hacer es desplegar el grupo de recursos con:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=nb>group </span><span class=n>create</span> <span class=p>-</span><span class=n>-location</span> <span class=n>westeurope</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>agic-example</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Disclaimer</strong>: Los rangos de las redes, tamaños y nodos del cluster, etc&mldr; los he elegido muy arbitrariamente, en cada caso concreto es necesario evaluar los rangos necesarios. El único requisito clave es que el agw debe ser como mínimo <em>Standard_v2</em> y por tanto el <em>sku</em> de la IP pui también debe ser <em>Standard</em>.</p>
</blockquote>
<p>Sobre ese grupo de recursos vamos a desplegar una vnet con dos subredes (una para el AKS y otra para agw) ejecutando:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=n>network</span> <span class=n>vnet</span> <span class=n>create</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>agic-example</span><span class=n>-vnet</span> <span class=p>-</span><span class=n>-address-prefix</span> <span class=n>10</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>16</span>
<span class=n>az</span> <span class=n>network</span> <span class=n>vnet</span> <span class=n>subnet</span> <span class=n>create</span> <span class=n>-n</span> <span class=nb>aks-subnet</span> <span class=p>-</span><span class=n>-vnet-name</span> <span class=nb>agic-example</span><span class=n>-vnet</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-address-prefixes</span> <span class=s2>&#34;10.0.0.0/17&#34;</span>
<span class=n>az</span> <span class=n>network</span> <span class=n>vnet</span> <span class=n>subnet</span> <span class=n>create</span> <span class=n>-n</span> <span class=nb>agw-subnet</span> <span class=p>-</span><span class=n>-vnet-name</span> <span class=nb>agic-example</span><span class=n>-vnet</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-address-prefixes</span> <span class=s2>&#34;10.0.128.0/24&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Lo siguiente va a ser desplegar ya el cluster de AKS, para ello basta con ejecutar:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=n>aks</span> <span class=n>create</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>aks-cluster</span> <span class=p>-</span><span class=n>-enable-managed-identity</span> <span class=p>-</span><span class=n>-kubernetes-version</span> <span class=n>1</span><span class=p>.</span><span class=n>17</span><span class=p>.</span><span class=n>7</span> <span class=p>-</span><span class=n>-docker-bridge-address</span> <span class=s2>&#34;172.17.0.1/16&#34;</span> <span class=p>-</span><span class=n>-service-cidr</span> <span class=s2>&#34;10.1.0.0/16&#34;</span> <span class=p>-</span><span class=n>-dns-service-ip</span> <span class=s2>&#34;10.1.0.10&#34;</span> <span class=p>-</span><span class=n>-vnet-subnet-id</span> <span class=p>$(</span><span class=n>az</span> <span class=n>network</span> <span class=n>vnet</span> <span class=n>subnet</span> <span class=n>show</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>aks-subnet</span> <span class=p>-</span><span class=n>-vnet-name</span> <span class=nb>agic-example</span><span class=n>-vnet</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-network-plugin</span> <span class=n>azure</span> <span class=p>-</span><span class=n>-zones</span> <span class=n>3</span> <span class=p>-</span><span class=n>-node-count</span> <span class=n>3</span> <span class=p>-</span><span class=n>-no-ssh-key</span> <span class=p>-</span><span class=n>-disable-rbac</span>

<span class=n>az</span> <span class=n>role</span> <span class=n>assignment</span> <span class=n>create</span> <span class=p>-</span><span class=n>-assignee</span> <span class=p>$(</span><span class=n>az</span> <span class=n>aks</span> <span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>aks-cluster</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;identity.principalId&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-scope</span> <span class=p>$(</span><span class=n>az</span> <span class=n>network</span> <span class=n>vnet</span> <span class=n>subnet</span> <span class=n>show</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>aks-subnet</span> <span class=p>-</span><span class=n>-vnet-name</span> <span class=nb>agic-example</span><span class=n>-vnet</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-role</span> <span class=s2>&#34;Network Contributor&#34;</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Importante</strong>: La asignación del rol &ldquo;Network Contributor&rdquo; es obligatoria al haber elegido el despliegue del cluster utilizando una identidad manejada en lugar de un <em>service principal</em>. En caso de que no se haga, el cluster tendrá fallos durante la operación.</p>
</blockquote>
<p>Ya casí hemos terminado de desplegar infraestructura, solo nos queda la parte relativa al agw, la cual vamos a desplegar ejecutando:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=n>network</span> <span class=nb>public-ip</span> <span class=n>create</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>agw-pip</span> <span class=p>-</span><span class=n>-sku</span> <span class=n>Standard</span>

<span class=n>az</span> <span class=n>network</span> <span class=nb>application-gateway</span> <span class=n>create</span> <span class=p>-</span><span class=n>-capacity</span> <span class=n>1</span> <span class=p>-</span><span class=n>-http-settings-cookie-based-affinity</span> <span class=n>Enabled</span> <span class=p>-</span><span class=n>-http-settings-port</span> <span class=n>80</span> <span class=p>-</span><span class=n>-http-settings-protocol</span> <span class=n>Http</span> <span class=p>-</span><span class=n>-location</span> <span class=n>westeurope</span> <span class=p>-</span><span class=n>-name</span> <span class=n>agw</span> <span class=p>-</span><span class=n>-public-ip-address</span> <span class=p>$(</span><span class=n>az</span> <span class=n>network</span> <span class=nb>public-ip</span> <span class=n>show</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>agw-pip</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-resource-group</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-sku</span> <span class=n>Standard_v2</span> <span class=p>-</span><span class=n>-subnet</span> <span class=nb>agw-subnet</span> <span class=p>-</span><span class=n>-vnet-name</span> <span class=nb>agic-example</span><span class=n>-vnet</span>
</code></pre></td></tr></table>
</div>
</div><p>Si todo ha ido bien, deberíamos poder ir al portal de Azure y encontrarnos algo como esto:</p>
<p><img src=/images/posts/2020-08-03-infra.png alt="&ldquo;La imagen muestra el grupo de recursos del portal de Azure donde se ven la vnet, el agw, la ip pública y el AKS&rdquo;"></p>
<h2 id=requisitos>Requisitos</h2>
<p>Después de un rato, ya tenemos la infraestructura lista para empezar a desplegar agic. Como decía antes, agic tiene 2 modos de autenticarse en Azure, utilizando un <em>service principal</em> o útilizando una identidad manejada. El hecho de que elijamos un sistema u otro va a cambiar la manera de proceder. Si elegimos utilizar un <em>service principal</em>, vamos a tener que crearlo y asignarle los permisos. En caso de utilizar una identidad manejada, vamos a tener que crearla y asignarle los permisos. ¿Dónde cambia entonces el proceso? Pues en que si utilizamos una entidad manejada, vamos a necesitar añadir al cluster un proxy de autenticación para que esa identidad pueda trabajar. Esto lo vamos a conseguir desplegando antes de agic ese proxy que en nuestro caso va a ser <a href=https://github.com/Azure/aad-pod-identity>AAD-Pod-Identity</a>.</p>
<p>En resumen, vamos a necesitar:</p>
<ul>
<li>Una entidad manejada</li>
<li>Asignación de permisos (tanto a la nueva identidad como al cluster)</li>
<li>Desplegar AAD-Pod-Identity</li>
</ul>
<p>Lo primero que vamos a hacer es crear nuestra nueva identidad manejada con el comando:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=n>identity</span> <span class=n>create</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span>
</code></pre></td></tr></table>
</div>
</div><p>Ahora, son 5 las asignaciones de roles que tenemos que realizar:</p>
<ol>
<li>La nueva identidad debe ser <em>Contributor</em> de agw</li>
<li>La nueva identidad debe ser <em>Reader</em> del grupo de recursos donde se encuentra agw</li>
<li>La identidad del cluster debe ser <em>Managed Identity Operator</em> de la nueva identidad</li>
<li>La identidad de Kubelet debe ser contribuidor del grupo de recursos de los nodos</li>
<li>La identidad de Kubelet debe ser <em>Managed Identity Operator</em> de la nueva identidad</li>
</ol>
<blockquote>
<p>Aunque estos dos últimos puede parecer que no tienen sentido ya que la identidad del cluster ya tiene esos permisos, es necesario para que AAD-Pd-Identity pueda trabajar, para mas info os dejo la <a href=https://github.com/Azure/aad-pod-identity/blob/v1.5.5/docs/readmes/README.msi.md>issue en GitHub donde se habla del tema</a></p>
</blockquote>
<p>Teniendo claro el camino, vamos con ello. Para eso basta con ejecutar los siguientes comandos:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=c># 1</span>
<span class=n>az</span> <span class=n>role</span> <span class=n>assignment</span> <span class=n>create</span> <span class=p>-</span><span class=n>-assignee</span> <span class=p>$(</span><span class=n>az</span> <span class=n>identity</span> <span class=n>show</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;principalId&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-scope</span> <span class=p>$(</span><span class=n>az</span> <span class=n>network</span> <span class=nb>application-gateway</span> <span class=n>show</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=n>agw</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-role</span> <span class=s2>&#34;Contributor&#34;</span>
<span class=c># 2</span>
<span class=n>az</span> <span class=n>role</span> <span class=n>assignment</span> <span class=n>create</span> <span class=p>-</span><span class=n>-assignee</span> <span class=p>$(</span><span class=n>az</span> <span class=n>identity</span> <span class=n>show</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;principalId&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-scope</span> <span class=p>$(</span><span class=n>az</span> <span class=nb>group </span><span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-role</span> <span class=s2>&#34;Reader&#34;</span>
<span class=c># 3</span>
<span class=n>az</span> <span class=n>role</span> <span class=n>assignment</span> <span class=n>create</span> <span class=p>-</span><span class=n>-assignee</span> <span class=p>$(</span><span class=n>az</span> <span class=n>aks</span> <span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>aks-cluster</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;identity.principalId&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-scope</span> <span class=p>$(</span><span class=n>az</span> <span class=n>identity</span> <span class=n>show</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-role</span> <span class=s2>&#34;Managed Identity Operator&#34;</span>
<span class=c># 4</span>
<span class=n>az</span> <span class=n>role</span> <span class=n>assignment</span> <span class=n>create</span> <span class=p>-</span><span class=n>-assignee</span> <span class=p>$(</span><span class=n>az</span> <span class=n>aks</span> <span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>aks-cluster</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;identityProfile.kubeletidentity.objectId&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-scope</span> <span class=p>$(</span><span class=n>az</span> <span class=nb>group </span><span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=p>$(</span><span class=n>az</span> <span class=n>aks</span> <span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>aks-cluster</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;nodeResourceGroup&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-role</span> <span class=s2>&#34;Contributor&#34;</span>
<span class=c># 5</span>
<span class=n>az</span> <span class=n>role</span> <span class=n>assignment</span> <span class=n>create</span> <span class=p>-</span><span class=n>-assignee</span> <span class=p>$(</span><span class=n>az</span> <span class=n>aks</span> <span class=n>show</span> <span class=p>-</span><span class=n>-name</span> <span class=nb>aks-cluster</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;identityProfile.kubeletidentity.objectId&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-scope</span> <span class=p>$(</span><span class=n>az</span> <span class=n>identity</span> <span class=n>show</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>-</span><span class=n>-role</span> <span class=s2>&#34;Managed Identity Operator&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Ahora si que hemos terminado de desplegar todo lo que necesitamos en Azure :)</p>
<h2 id=desplegar-aad-pod-identity-en-el-cluster>Desplegar AAD-Pod-Identity en el cluster</h2>
<p>Ya ha llegado la hora de trabajar en el cluster y vamos a empezar con AAD-Pod-Identity ya que es requisito para agic con el modelo de identidad manejada. Existen varias maneras de desplegar AAD-Pod-Identity en el cluster, pero para esta entrada vamos a optar por la que personalmente me parece más fácil, que es utilizando Helm directamente. Lo primero que vamos a necesitar es obtener el contexto para <em>kubectl</em>, esto lo vamos a conseguir simplemente utilizando <em>az aks get-cred<br>
entials</em></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=n>aks</span> <span class=nb>get-credentials</span> <span class=n>-n</span> <span class=nb>aks-cluster</span> <span class=n>-g</span> <span class=nb>agic-example</span>
</code></pre></td></tr></table>
</div>
</div><p>A partir de aquí, ya hemos sincronizado el contexto y basta con ejecutar:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>helm</span> <span class=n>repo</span> <span class=n>add</span> <span class=nb>aad-pod</span><span class=n>-identity</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>raw</span><span class=p>.</span><span class=n>githubusercontent</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>Azure</span><span class=p>/</span><span class=nb>aad-pod</span><span class=n>-identity</span><span class=p>/</span><span class=n>master</span><span class=p>/</span><span class=n>charts</span>
<span class=n>helm</span> <span class=n>install</span> <span class=p>-</span><span class=n>-set</span> <span class=n>mic</span><span class=p>.</span><span class=n>leaderElection</span><span class=p>.</span><span class=n>namespace</span><span class=p>=</span><span class=nb>aad-pod</span><span class=n>-identity</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-set</span> <span class=n>nmi</span><span class=p>.</span><span class=n>micNamespace</span><span class=p>=</span><span class=nb>aad-pod</span><span class=n>-identity</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-namespace</span> <span class=nb>aad-pod</span><span class=n>-identity</span> <span class=p>-</span><span class=n>-create-namespace</span>
              <span class=nb>aad-pod</span><span class=n>-identity</span> <span class=nb>aad-pod</span><span class=n>-identity</span><span class=p>/</span><span class=nb>aad-pod</span><span class=n>-identity</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Los valores que configuramos simplemente son para que nuestro aad-pod-identity se despliegue en un namespace concreto en vez de el valor por defecto. Si por el contrario los valores por defecto son suficientes, bastaría con ejecutar <code>helm install aad-pod-identity aad-pod-identity/aad-pod-identity</code></p>
</blockquote>
<p>Podemos comprobar que esto ha funcionado ejecutando:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>kubectl</span> <span class=n>get</span> <span class=n>pods</span> <span class=n>-n</span> <span class=nb>aad-pod</span><span class=n>-idenity</span>
</code></pre></td></tr></table>
</div>
</div><p>Lo que debería devolvernos algo parecido a esto:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>NAME</span>                                    <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=nb>aad-pod</span><span class=n>-identity-mic</span><span class=p>-</span><span class=n>6b49f5c66b-fffn5</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>30m</span>
<span class=nb>aad-pod</span><span class=n>-identity-mic</span><span class=p>-</span><span class=n>6b49f5c66b-tgxk5</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>30m</span>
<span class=nb>aad-pod</span><span class=n>-identity-nmi-gj729</span>              <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>30m</span>
<span class=nb>aad-pod</span><span class=n>-identity-nmi-l5r6z</span>              <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>30m</span>
<span class=nb>aad-pod</span><span class=n>-identity-nmi-rtqqj</span>              <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>30m</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=desplegar-application-gateway-ingress-controller>Desplegar Application-Gateway-Ingress-Controller</h2>
<p>Ahora sí que hemos llegado al punto final, ya lo tenemos todo listo para poder desplegar agic y que funcione correctamente. Para poder desplegarlo simplemente tenemos que ejecutar:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>helm</span> <span class=n>repo</span> <span class=n>add</span> <span class=nb>application-gateway</span><span class=n>-kubernetes-ingress</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>appgwingress</span><span class=p>.</span><span class=n>blob</span><span class=p>.</span><span class=n>core</span><span class=p>.</span><span class=n>windows</span><span class=p>.</span><span class=n>net</span><span class=p>/</span><span class=nb>ingress-azure</span><span class=n>-helm-package</span><span class=p>/</span>
<span class=n>helm</span> <span class=n>install</span> <span class=p>-</span><span class=n>-set</span> <span class=n>appgw</span><span class=p>.</span><span class=n>subscriptionId</span><span class=p>=&lt;</span><span class=n>Suscripción</span><span class=p>&gt;</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-set</span> <span class=n>appgw</span><span class=p>.</span><span class=n>resourceGroup</span><span class=p>=</span><span class=nb>agic-example</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-set</span> <span class=n>appgw</span><span class=p>.</span><span class=n>name</span><span class=p>=</span><span class=n>agw</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-set</span> <span class=n>armAuth</span><span class=p>.</span><span class=n>type</span><span class=p>=</span><span class=n>aadPodIdentity</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-set</span> <span class=n>armAuth</span><span class=p>.</span><span class=n>identityClientID</span><span class=p>=$(</span><span class=n>az</span> <span class=n>identity</span> <span class=n>show</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;clientId&#34;</span><span class=p>)</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-set</span> <span class=n>armAuth</span><span class=p>.</span><span class=n>identityResourceID</span><span class=p>=$(</span><span class=n>az</span> <span class=n>identity</span> <span class=n>show</span> <span class=n>-n</span> <span class=n>identity</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=p>\</span>
             <span class=p>-</span><span class=n>-namespace</span> <span class=n>agic</span> <span class=p>-</span><span class=n>-create-namespace</span> <span class=p>\</span>
             <span class=n>agic</span> <span class=nb>application-gateway</span><span class=n>-kubernetes-ingress</span><span class=p>/</span><span class=nb>ingress-azure</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Los valores que estamos configurando son bastante explícitos en cuanto a su significado y que es lo que hay que asignar, pero por las dudas, dejo el <a href=https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/helm-values-documenation.md>enlace a la descripción de los valores</a>.</p>
</blockquote>
<p>Sí todo ha ido según se espera, deberíamos obtener una respuesta como esta al ejecutar</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>kubectl</span> <span class=n>get</span> <span class=n>pods</span> <span class=n>-n</span> <span class=n>agic</span>
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>NAME</span>                                  <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>
<span class=nb>agic-ingress</span><span class=n>-azure</span><span class=p>-</span><span class=n>78b9f88b5d</span><span class=p>-</span><span class=n>6q2v9</span>   <span class=n>1</span><span class=p>/</span><span class=n>1</span>     <span class=n>Running</span>   <span class=n>0</span>          <span class=n>63s</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=probando-application-gateway-ingress-controller>Probando Application-Gateway-Ingress-Controller</h2>
<p>Llegados a este punto, ya tenemos desplegado agic en nuestro cluster y ya solo nos queda probarlo. Antes de empezar con la prueba, es importante conocer que agic soporta anotaciones con configuraciones específicas para el ingress en concreto. Para más información sobre ellas, os recomiendo echarle un ojo a la <a href=https://github.com/Azure/application-gateway-kubernetes-ingress/blob/master/docs/annotations.md>documentación</a> ya que es un repositorio muy joven y constantemente recibe nuevas características.</p>
<p>Por último, vamos a desplegar una carga de trabajo simple como puede ser:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/ingress.class</span><span class=p>:</span><span class=w> </span><span class=l>azure/application-gateway</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>http</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w>          </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>microsoft/dotnet-samples:aspnetapp</span><span class=w>
</span><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;128Mi&#34;</span><span class=w>
</span><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>sample-app</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Una vez añadido al cluster, agic empezará automáticamente su preceso de actualización. Una vez termine (unos 10-20 segundos), podemos comprobar que el agw se ha configurado correctamente simplemente poniendo en el navegador la ip que hemos creado como ip pública del agw, la cual podemos obtener con el comando:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>az</span> <span class=n>network</span> <span class=nb>public-ip</span> <span class=n>show</span> <span class=n>-g</span> <span class=nb>agic-example</span> <span class=n>-n</span> <span class=nb>agw-pip</span> <span class=p>-</span><span class=n>-query</span> <span class=s2>&#34;ipAddress&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Si todo ha ido bien, deberíamos encontrarnos con una web como esta:</p>
<p><img src=/images/posts/2020-08-03-result.png alt="&ldquo;La imagen muestra la web de ejemplo de ASP NET Core, no tiene ningún valor adicional ni contenido relevante&rdquo;"></p>
<p>Con esto, hemos conseguido desplegar y validar nuestro agic :).</p>
<h2 id=conclusión>Conclusión</h2>
<p>Aunque parece un poco tedioso, agic ofrece una mejora en la gestión del tráfico de nuestras aplicaciones. Es cierto que para poder usarlo es necesario que el agw sea como mínimo un <em>Standard_v2</em> y que eso vale dinero, por lo que no es habitual montarlo para usar agic. Eso no quiere decir que si ya lo tenemos, utilizar agic sea una opción muy interesante.</p>
<p>Aquí solo he planteado el utilizarlo como ingress por evitar unos saltos de red, pero la realidad es que ofrece más cosas aparte como por ejemplo el decidir que ingress se sirven por la IP pública y cuales por la privada (aunque no por las dos a la vez), o por ejemplo la posibilidad de utilizar las métricas de agw como fuente para un HPA (<strong>H</strong>orizontal <strong>P</strong>od <strong>A</strong>utoscaler, autoescalado horizontal).</p>
<p>Y con esto me despido, ha sido todo un placer poder compartir agic con todos vosotros, y estaré encantado de vovler para contaros más cosas si Eduard me lo permite :). Por lo pronto, muchas gracias a todos por leerme y a Eduard por dejarme estar aquí.</p>
<p><strong>¡¡Hasta la próxima!!</strong></p>
</article>
<script>'use strict';function wrap(a,b){a.parentNode.insertBefore(b,a),b.appendChild(a)}(function(){var a=document.querySelector('.single__contents');a?a.querySelectorAll('pre > code').forEach(function(b){var a=b.getAttribute('data-lang'),c=document.createElement('div'),e=null,d=null;a&&a.includes(':')?(e=a.split(':')[0],d=a.split(':')[1],c.className='language-'+e,c.setAttribute('data-lang',d),b.className='language-'+e,b.setAttribute('data-lang',d),b.setAttribute('id',d)):a||(c.setAttribute('data-lang','Code'),c.className='language-code'),(!a||d)&&wrap(b.parentNode,c)}):null})();var langCodeElem=document.querySelectorAll('.language-code');langCodeElem?langCodeElem.forEach(function(b){var a=document.createElement('span');a.className='copy-to-clipboard',a.setAttribute('title','Copy to clipboard'),b.append(a)}):null</script>
<div class=whoami__gutter></div>
<hr class="hr-slash whoami-hr">
<section class=whoami>
<div class=whoami__image-wrapper>
<img data-src=/images/whoami/jturrado.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt=eiximenis class="lazyload whoami__image">
</div>
<div class=whoami__contents>
<div class=whoami__written-by>
ESCRITO POR
</div>
<div class=whoami__title>
Jorge Turrado
</div>
<div class=whoami__desc>
Apasionado por programación y el mundo del software, empecé en esto hace muchos años con VB6 y tutoriales haciendo mi primera calculadora. Autodidacta nato, le debo prácticamente todo a la comunidad, que es de donde pude aprender todo lo que se hoy día. A lo largo de mi carrera he tocado muchos palos de diferentes ramas como la robótica, automatismo, visión artificial, servicios de alto rendimiento y actualmente he caído en la web y la nube.
Cuando no estoy trabajando, investigando alguna tecnología o colaborando en algún proyecto Open Source, me gusta jugar al balonmano, salir a pasear con mi pareja y mis perros, ir a nadar, ir al cine (casi como si no fuera un mago nivel 80 xD)… Y después de hacer todas esas cosas el poco tiempo que me queda lo dedico a crear contenido para ese pequeño rinconcito que tengo en internet que es mi blog.
</div>
<div class=whoami__social>
</div>
</div>
</section>
<hr class="hr-slash whoami-hr">
<section class=related>
</section>
<div class=grow></div>
<nav class=pagination-single>
<a href=https://www.eiximenis.dev/posts/2020-07-08-testing-metodos-privados/ class=pagination-single__left>
<div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg>
</div>
<div class=pagination-single__left-title>Unit testing de métodos privados</div>
</a>
<div class=grow></div>
<a href=https://www.eiximenis.dev/posts/2020-08-04-csharp-funcional-con-arrowsharp/ class=pagination-single__right>
<div class=pagination-single__right-title>C# funcional con Arrow Sharp</div>
<div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg>
</div>
</a>
</nav>
<div id=disqus_thread></div>
<script>let disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='https://locrestia.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<div class="modal micromodal-slide" id=modal aria-hidden=true>
<div class=modal__overlay tabindex=-1 data-micromodal-close>
<div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title>
<div class=modal__content id=modal-content>
<div id=mySwipe class=swipe>
<div class=swipe-wrap>
</div>
</div>
</div>
<span class=modal__items>
<span class=modal__header>
<div class=modal__paging title="Page Info" aria-label="Current Page">
</div>
<div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg>
</div>
<div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg>
</div>
<div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg>
</div>
</span>
<div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg>
</div>
<div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg>
</div>
<div class=modal__caption>
<div class=modal__caption--text>
</div>
</div>
</span>
</div>
</div>
</div>
<script defer src=/js/swipe.min.d70095d96ef6a016133ea2c732c5d4713539d335b739178e356af46f54cf0a16.js></script>
<script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>document.addEventListener('DOMContentLoaded',function(){var d=document.documentElement,g,f,s,r,m,o,l,b,c,i,n,e,h,j,a,p,q;function t(){d.requestFullscreen?d.requestFullscreen():d.mozRequestFullScreen?d.mozRequestFullScreen():d.webkitRequestFullscreen?d.webkitRequestFullscreen():d.msRequestFullscreen&&d.msRequestFullscreen()}function k(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}g=document.getElementById('modal'),f=document.querySelector('.gallery__container'),s=document.querySelector('.swipe-wrap'),r=document.getElementById('mySwipe'),m=document.querySelector('.modal__arrow--left'),o=document.querySelector('.modal__arrow--right'),l=document.querySelector('.modal__toolbar--close'),b=document.querySelector('.modal__toolbar--full'),c=document.querySelector('.modal__toolbar--normal'),i=document.querySelector('.modal__caption'),n=document.querySelector('.modal__paging'),e=document.querySelector('.modal__items'),h=null,j=null,a=null,p=function(b){b.key==='ArrowRight'?g&&g.classList.contains('is-open')&&a.next():b.key==='ArrowLeft'&&g&&g.classList.contains('is-open')&&a.prev()},f?h=f.querySelectorAll('img').length:(f=document.querySelector('.single__contents'),h=f.querySelectorAll('img').length),MicroModal.init({onClose:function(){a&&(a.kill(),a=null,k()),window.removeEventListener('keydown',p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),q=function(a){return new Promise(function(c,d){var b=new Image;b.onload=function(){c(b)},b.onerror=d,b.src=a})},f.querySelectorAll('img').forEach(function(g,k){var f,d;g.style.cursor='pointer',f=g.cloneNode(!0),f.style.maxHeight='100%',f.style.maxWidth='100%',f.onclick=function(a){a.stopPropagation()},d=document.createElement('div'),d.style.width='100%',d.style.height='100vh',d.setAttribute('data-micromodal-close',''),d.onclick=function(){a&&(a.kill(),a=null)},d.onmouseenter=function(){clearTimeout(j),fadeIn(e,200)},d.onmouseleave=function(){j=setTimeout(function(){fadeOut(e,200)},2500)},d.ontouchstart=function(){fadeIn(e,200)},d.append(f),s.append(d),g.addEventListener('click',async function(d){var m,l,g;MicroModal.show('modal'),a&&(a.kill(),a=null),m=d.target.getAttribute('data-src')||d.target.getAttribute('src'),l=await q(m),f.style.width=l.width+'px',f.style.height=l.height+'px',a=new Swipe(r,{startSlide:k,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(d,f){var a=f.querySelector('img'),g=a.getAttribute('data-src')||a.getAttribute('src'),c=await q(g),b;a.style.width=c.width+'px',a.style.height=c.height+'px',i&&a&&(b=null,a.getAttribute('data-caption')?b=a.getAttribute('data-caption'):a.getAttribute('title')?b=a.getAttribute('title'):a.getAttribute('alt')?b=a.getAttribute('alt'):b=a.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=b,n.innerText=d+1+' / '+h,clearTimeout(j),fadeIn(e,200))}}),fadeIn(e),i&&(g=null,d.target.getAttribute('data-caption')?g=d.target.getAttribute('data-caption'):d.target.getAttribute('title')?g=d.target.getAttribute('title'):d.target.getAttribute('alt')?g=d.target.getAttribute('alt'):g=d.target.getAttribute('src'),i.querySelector('.modal__caption--text').innerText=g,n.innerText=k+1+' / '+h),c&&b&&(c.style.zIndex=-1,c.style.opacity=0,b.style.zIndex=25,b.style.opacity=1)}),window.addEventListener('keydown',p)}),m?m.addEventListener('click',function(b){a&&a.prev()}):null,o?o.addEventListener('click',function(b){a&&a.next()}):null,l?l.addEventListener('click',function(){a&&(a.kill(),a=null),k(),MicroModal.close('modal')}):null,b?b.addEventListener('click',function(a){t(),c&&(c.style.zIndex=25,c.style.opacity=1,b.style.zIndex=-1,b.style.opacity=0)}):null,c?c.addEventListener('click',function(a){k(),b&&(b.style.zIndex=25,b.style.opacity=1,c.style.zIndex=-1,c.style.opacity=0)}):null})</script>
<div class=hide>
<div class=search>
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
</span>
<input id=search aria-label="Site Search" class=input type=text placeholder=Buscar autocomplete=off>
<div id=search-results class=dropdown>
<div id=search-menu class=dropdown-menu role=menu>
</div>
</div>
</div>
</div>
</div>
</main>
<aside class="single__side main-side">
<section class="sidebar hide">
<script>document.querySelector('.sidebar').classList.remove('hide')</script>
<div class=toc__flexbox data-position=fixed>
<h6 class=toc__title data-ani=true>Qué hay aquí</h6>
<label class=switch data-ani=true>
<input id=toggle-toc aria-label="Toggle TOC" type=checkbox checked>
<span class="slider round"></span>
</label>
</div>
<div class=toc data-dir=ltr data-folding=false data-ani=true>
<nav id=TableOfContents>
<ul>
<li><a href=#prerrequisitos>Prerrequisitos</a></li>
<li><a href=#requisitos>Requisitos</a></li>
<li><a href=#desplegar-aad-pod-identity-en-el-cluster>Desplegar AAD-Pod-Identity en el cluster</a></li>
<li><a href=#desplegar-application-gateway-ingress-controller>Desplegar Application-Gateway-Ingress-Controller</a></li>
<li><a href=#probando-application-gateway-ingress-controller>Probando Application-Gateway-Ingress-Controller</a></li>
<li><a href=#conclusión>Conclusión</a></li>
</ul>
</nav>
</div>
</section>
</aside>
<script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse("null"),singleMainElem=document.querySelector('.single__main'),singleSideElem=document.querySelector('.single__side');enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main'),singleSideElem.classList.remove('main-side'),singleSideElem.classList.add('hide')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide'))},unmatch:function(){var b,a;(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove('main'),singleMainElem.classList.add('main-main'),singleSideElem.classList.remove('hide'),singleSideElem.classList.add('main-side')):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains('main-main')&&(singleMainElem.classList.remove('main-main'),singleMainElem.classList.add('main')),singleSideElem&&!singleSideElem.classList.contains('hide')&&singleSideElem.classList.add('hide')),b=document.querySelector('.navbar__burger'),a=document.getElementsByClassName('navbarm__collapse')[0],a&&(a.setAttribute('data-open',!1),a.style.maxHeight=0,b.classList.remove('is-active')),document.getElementsByClassName('navbar__menu')[0].classList.remove('is-active'),document.getElementsByClassName('mobile-search')[0].classList.add('hide')},setup:function(){},deferSetup:!0,destroy:function(){}})</script>
<script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script>
<script defer src=/js/helper/getParents.min.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>'use strict';window.onload=function(){var q=document.querySelector('.navbar'),K=document.querySelector('.single__contents'),Q=JSON.parse("false"),P=JSON.parse("true"),x,H,O,T,j,k,L,f,D,v,d,e,m,l,G,t,u,R,I,C,N,z,A,B,h,i,E,F,b,y,w,S,g,c,M,a,p,s,n,o,J,r;Q&&P&&(x=document.querySelector('#busuanzi_value_page_pv'),x.textContent=x.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),H=JSON.parse("true"),O=JSON.parse("null"),T=JSON.parse("false"),j=document.querySelector('.toc__flexbox'),k=document.querySelector('.toc__flexbox--outer'),L=JSON.parse("null"),(H||O)&&document.querySelector('.toc')&&(f=document.querySelector('.toc').querySelector('#TableOfContents'),!1===L||(f.querySelectorAll('ul')?f.querySelectorAll('ul').forEach(function(a){a.querySelectorAll('li').forEach(function(a){a.querySelectorAll('ul').forEach(function(a){a.style.display='none'})})}):null),f&&(f.querySelectorAll('a').length>0?f.querySelectorAll('a').forEach(function(a){a.addEventListener('click',function(){var c=a.getAttribute('id'),b;q.classList.remove('navbar--show'),q.classList.remove('navbar--hide'),q.classList.add('navbar--hide'),document.querySelector('.toc').querySelectorAll('a').forEach(function(a){a.classList.remove('active')}),a.classList.add('active'),b=f.querySelector('[href="#'+c+'"]'),b&&b.nextElementSibling&&(b.nextElementSibling.style.display='block'),b&&(getParents(b,'ul')?getParents(b,'ul').forEach(function(a){a.style.display='block'}):null)})}):(j&&(j.setAttribute('data-position',''),j.classList.contains('hide')||j.classList.add('hide')),k&&(k.setAttribute('data-position',''),k.classList.contains('hide')||k.classList.add('hide')))),D=document.getElementById("toggle-toc"),v=document.getElementById('visible-toc'),d=document.querySelector('.toc'),e=document.querySelector('main'),m=document.querySelector('side'),l=document.querySelector('.toc__flexbox'),D?D.addEventListener('change',function(a){a.target.checked?(d&&fadeIn(d,200),l&&l.setAttribute('data-position','fixed'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main-main')),m&&m.classList.remove('main-side')):(d&&fadeOut(d,200),l&&l.setAttribute('data-position','absolute'),e&&(e.classList.remove('main-main'),e.classList.remove('main'),e.classList.add('main')),m&&m.classList.remove('main-side'))}):null,v?v.addEventListener('change',function(a){a.target.checked?d&&fadeIn(d,200):d&&fadeOut(d,200)}):null),G=document.querySelectorAll('.single__contents > table');for(let a=0;a<G.length;a++)t=G[a],u=document.createElement('div'),u.className='table-wrapper',t.parentElement.replaceChild(u,t),u.appendChild(t);I=new ClipboardJS('.anchor'),C=K.querySelectorAll("h1, h2, h3, h4"),N=JSON.parse('"ltr"'),C?C.forEach(function(c){var d=encodeURI(document.location.origin+document.location.pathname),e=d+"#"+c.getAttribute('id'),b=document.createElement('span'),a;b.classList.add('anchor'),b.classList.add('hide'),b.setAttribute('data-clipboard-text',e),b.style.position='relative',a=document.createElement('span'),a.style.fontSize='1rem',a.style.position='absolute',a.style.top='50%',a.style.transform='translateY(-50%)',a.innerText="🔗",N==="rtl"?a.style.left='-2rem':a.style.right='-2rem',b.append(a),c.append(b),c.addEventListener('mouseenter',function(){this.querySelector('.anchor').classList.remove('hide')}),c.addEventListener('mouseleave',function(){this.querySelector('.anchor').classList.add('hide')})}):null,document.querySelectorAll('.anchor').forEach(function(a){a.addEventListener('mouseleave',function(){a.setAttribute('aria-label',null),a.classList.remove('tooltipped'),a.classList.remove('tooltipped-s'),a.classList.remove('tooltipped-w')})}),I.on('success',function(a){a.clearSelection(),a.trigger.setAttribute('aria-label','Link copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-s')}),z=!1,A=document.querySelectorAll('pre.chroma'),B=document.querySelectorAll('.language-code'),h=document.querySelectorAll('div.language-\\$'),i=document.querySelectorAll('div.language-\\>'),E=function(b){var j=b,a=b.textContent,i,f,g,h,c,e,d;if(a.length>15){z||(i=new ClipboardJS('.copy-to-clipboard',{text:function(b){var c=prev(b).querySelectorAll('code');return c.length>1?a=prev(b).querySelector('code[class^="language-"]').textContent:a=prev(b).querySelector('code').textContent,a.replace(/^\$\s/gm,'')}}),i.on('success',function(a){a.clearSelection(),f=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label','Copied to clipboard!'),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),i.on('error',function(a){f=prop(a.trigger.parentNode,'tagName')=='PRE',a.trigger.setAttribute('aria-label',a.action.toString()),a.trigger.classList.add('tooltipped'),a.trigger.classList.add('tooltipped-w')}),z=!0),g=['language-mermaid','language-viz','language-wave','language-chart','language-msc','language-flowchart'],h=!1,c=j.getAttribute('class');for(e=0;e<g.length;e++)if(c&&c.startsWith(g[e])){h=!0;break}h||c&&(d=document.createElement('span'),d.setAttribute('class','copy-to-clipboard'),d.setAttribute('title','Copy to clipboard'),b.parentNode.parentNode.insertBefore(d,b.parentNode.nextElementSibling))}},F=function(b){var a=document.createElement('span');a.setAttribute('class','copy-to-clipboard'),a.setAttribute('title','Copy to clipboard'),b.parentNode.parentNode.insertBefore(a,b.parentNode.nextElementSibling)},A?A.forEach(function(a){a.querySelectorAll('code').forEach(function(a){E(a)})}):null,B?B.forEach(function(a){a.querySelectorAll('code').forEach(function(a){E(a)})}):null,h?h.forEach(function(a){a.querySelectorAll('code').forEach(function(a){F(a)})}):null,i?i.forEach(function(a){a.querySelectorAll('code').forEach(function(a){F(a)})}):null,h?h.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='$<br/>'}):null}):null,i?i.forEach(function(a){var b=a.parentNode.parentNode?a.parentNode.parentNode.querySelectorAll('.lnt'):null;b?b.forEach(function(a){a.innerHTML='><br/>'}):null}):null,b=JSON.parse("null"),b&&b.includes('mermaid')&&(y=localStorage.getItem('theme')||JSON.parse('"dark"'),y==="dark"||y==="hacker"?mermaid.initialize({theme:'dark'}):mermaid.initialize({theme:'default'}),w=[],[].push.apply(w,document.getElementsByClassName('language-mermaid')),w.forEach(function(b){var a=b.parentNode,c;a!==document.body&&(a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a)),c=document.createElement('div'),c.classList.add('mermaid'),c.style.padding='34px 4px 6px',c.innerHTML=b.innerHTML,b.replaceWith(c)})),b&&b.includes('katex')&&(S=document.getElementsByClassName('math'),g={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector('.single__contents'),g)),b&&b.includes('flowchartjs')&&(g=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),c=null,M="language-flowchart",a=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+M+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='flowchart'+a,b.parentNode.insertBefore(d,b),e=flowchart.parse(c),e.drawSVG("flowchart"+a,g),a+=1})),b&&b.includes('msc')&&(g=JSON.parse('{"theme":"hand"}'),c=null,a=0,p="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+p+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),d.id='msc'+a,b.parentNode.insertBefore(d,b),e=Diagram.parse(c),e.drawSVG("msc"+a,g),a+=1})),b&&b.includes('chart')&&(s="#666",n="#ddd",o=2,Chart.defaults.global.elements.rectangle.borderWidth=o,Chart.defaults.global.elements.rectangle.borderColor=s,Chart.defaults.global.elements.rectangle.backgroundColor=n,Chart.defaults.global.elements.line.borderWidth=o,Chart.defaults.global.elements.line.borderColor=s,Chart.defaults.global.elements.line.backgroundColor=n,Chart.defaults.global.elements.point.borderWidth=o,Chart.defaults.global.elements.point.borderColor=s,Chart.defaults.global.elements.point.backgroundColor=n,p="language-chart",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+p+"]"),function(b){var d,e,f,g;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('canvas'),e=null,d.height=200,d.style.height=200,d.id='myChart'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),f=document.getElementById('myChart'+a).getContext('2d'),g=new Chart(f,e),a+=1})),b&&b.includes('wavedrom')&&(J="language-wave",a=0,c=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+J+"]"),function(b){var d,e;b.style.display='none',b.parentNode.style.backgroundColor="transparent",c=b.innerText,d=document.createElement('div'),e=null,d.id='WaveDrom_Display_'+a,e=JSON.parse(c),b.parentNode.insertBefore(d,b),WaveDrom.RenderWaveForm(a,e,"WaveDrom_Display_"),a+=1})),b&&b.includes('viz')&&(r="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+r+"]"),function(a){var b,c;a.style.display='none',a.parentNode.style.backgroundColor="transparent",a.getAttribute("class").split(" ").forEach(function(a){a.startsWith(r)&&(b=a.substr(r.length))}),c=new Viz,c.renderSVGElement(a.innerText,{engine:b}).then(function(b){b.style.width="100%",a.parentNode.insertBefore(b,a)})}))}</script>
<footer class=footer>
<div class=dropdown>
<button class=dropdown-trigger aria-label="Select Theme Button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12.65 15.67c.14-.36.05-.77-.23-1.05l-2.09-2.06.03-.03c1.74-1.94 2.98-4.17 3.71-6.53h1.94c.54.0.99-.45.99-.99v-.02c0-.54-.45-.99-.99-.99H10V3c0-.55-.45-1-1-1s-1 .45-1 1v1H1.99c-.54.0-.99.45-.99.99.0.55.45.99.99.99h10.18C11.5 7.92 10.44 9.75 9 11.35c-.81-.89-1.49-1.86-2.06-2.88-.16-.29-.45-.47-.78-.47-.69.0-1.13.75-.79 1.35.63 1.13 1.4 2.21 2.3 3.21L3.3 16.87c-.4.39-.4 1.03.0 1.42.39.39 1.02.39 1.42.0L9 14l2.02 2.02c.51.51 1.38.32 1.63-.35zM17.5 10c-.6.0-1.14.37-1.35.94l-3.67 9.8c-.24.61.22 1.26.87 1.26.39.0.74-.24.88-.61l.89-2.39h4.75l.9 2.39c.14.36.49.61.88.61.65.0 1.11-.65.88-1.26l-3.67-9.8c-.22-.57-.76-.94-1.36-.94zm-1.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
</button>
<div class=dropdown-content>
<a href=https://www.eiximenis.dev/posts/2020-08-03-controlar-agic-desde-aks/ data-lang=es class="dropdown-item is-active">Español</a>
</div>
</div>
<div class=footer__social>
<div class=social>
<a href=https://www.eiximenis.dev/posts//index.xml type=application/rss+xml title=RSS aria-label="RSS Feed Link"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><circle fill="currentcolor" cx="6.18" cy="17.82" r="2.18"/><path fill="currentcolor" d="M5.59 10.23c-.84-.14-1.59.55-1.59 1.4.0.71.53 1.28 1.23 1.4 2.92.51 5.22 2.82 5.74 5.74.12.7.69 1.23 1.4 1.23.85.0 1.54-.75 1.41-1.59-.68-4.2-3.99-7.51-8.19-8.18zm-.03-5.71C4.73 4.43 4 5.1 4 5.93c0 .73.55 1.33 1.27 1.4 6.01.6 10.79 5.38 11.39 11.39.07.73.67 1.28 1.4 1.28.84.0 1.5-.73 1.42-1.56-.73-7.34-6.57-13.19-13.92-13.92z"/></svg>
</a>
</div>
</div>
<div id=gtt>
<div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg>
</div>
</div>
<hr>
<div class=basicflex>
</div>
<div class=footer__poweredby>
<p class=caption>
<a rel=license href=https://creativecommons.org/licenses/by/4.0/ class=footer__copyright--img><img alt="Contenido bajo licencia CC-BY" style=border-width:0 src=/images/cc.png></a><a rel=license href=https://creativecommons.org/licenses/by/4.0/>Contenido bajo licencia CC-BY</a>
</p>
</div>
</footer>
</div>
<div class="wrapper__right hide" data-pad=true dir=ltr>
<script>document.querySelector('.wrapper__right').classList.remove('hide')</script>
</div>
</div>
</body>
</html>